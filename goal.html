<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è²¡å‹™è¦åŠƒ - å¢¨é¡å§è¤‡åˆ©æ¨¹</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="src/tailwind.config.js"></script>
    <link rel="stylesheet" href="src/style.css">
    <link href="https://cdn.jsdelivr.net/npm/@mdi/font@5.x/css/materialdesignicons.min.css" rel="stylesheet">
    
</head>

<body class="bg-background text-gray-200">
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <h3>è¼‰å…¥ä¸­...</h3>
            <p>æ­£åœ¨æº–å‚™æ‚¨çš„è²¡å‹™è¦åŠƒå·¥å…·</p>
        </div>
    </div>

    <div id="app" style="opacity: 0; transition: opacity 0.5s ease-in;">
        <div id="chartTooltip" class="chart-tooltip"></div>
        <div class="container mx-auto px-4 py-8">
            <div class="max-w-7xl mx-auto">
                <header class="flex flex-wrap items-center justify-between gap-4 mb-6">
                    <h1><img class="w-48 h-auto" src="img/logo.svg" alt="å¢¨é¡å§è¤‡åˆ©æ¨¹"> </h1>
                    <nav class="relative z-20">
                        <div class="flex justify-end">
                            <button @click="toggleMenu" class="p-2 rounded-md hover:bg-surface focus:outline-none focus:ring-2 focus:ring-inset focus:ring-primary" aria-label="Open navigation menu">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7" />
                                </svg>
                            </button>
                        </div>
                    
                        <transition
                            enter-active-class="transition-opacity ease-in-out duration-300"
                            enter-from-class="opacity-0"
                            enter-to-class="opacity-100"
                            leave-active-class="transition-opacity ease-in-out duration-300"
                            leave-from-class="opacity-100"
                            leave-to-class="opacity-0"
                        >
                            <div v-if="isMenuOpen" class="fixed inset-0 z-50 bg-background/95 backdrop-blur-sm flex flex-col items-center justify-center">
                                
                                <button @click="toggleMenu" class="absolute top-5 right-5 p-2 text-gray-400 hover:text-white" aria-label="Close navigation menu">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                    </svg>
                                </button>
                                
                                <div class="flex flex-col items-center gap-8">
                                    <a @click="toggleMenu" href="goal.html" class="text-2xl text-primary font-semibold">è²¡å‹™è¦åŠƒ</a>
                                    <a @click="toggleMenu" href="all_weather.html" class="text-2xl text-gray-300 hover:text-primary transition-colors">å…¨å¤©å€™ç­–ç•¥</a>
                                    <a @click="toggleMenu" href="classic3.html" class="text-2xl text-gray-300 hover:text-primary transition-colors">ä¸‰åŸºé‡‘çµ„åˆ</a>
                                    <a @click="toggleMenu" href="aggressive.html" class="text-2xl hover:text-primary transition-colors">ç©æ¥µå‹è‚¡å‚µçµ„åˆ</a>
                                    <a @click="toggleMenu" href="core4.html" class="text-2xl text-gray-300 hover:text-primary transition-colors">æ ¸å¿ƒå››åŸºé‡‘</a>
                                    <a @click="toggleMenu" href="voo.html" class="text-2xl text-gray-300 hover:text-primary transition-colors">å·´è²ç‰¹æ¨è–¦</a>
                                </div>
                            </div>
                        </transition>
                    </nav>
                </header>

                <main class="bg-background rounded-lg p-2">

                    <div class="rounded-lg pb-6" v-if="savedGoals.length > 0">
                        <h3 class="text-xl font-semibold mb-4 flex items-center "><i class="mdi mdi-bookmark-outline mr-2"></i>å·²å­˜ç›®æ¨™</h3>
                        <div class="space-y-3">
                            <div v-for="(goal, index) in savedGoals" :key="index" class="p-3 border border-gray-700 rounded-lg cursor-pointer hover:bg-surface transition-colors" @click="loadSavedGoal(goal)">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <div class="font-bold">{{ goalTypes[goal.goalType].title }}</div>
                                        <div class="text-xs text-gray-400 mt-1">{{ goal.currentAge }}æ­² â†’ {{ goal.targetAge }}æ­² | ç›®æ¨™: {{ goal.targetValue.toLocaleString() }} {{ goal.goalType === 'retirement' ? 'ç¾å…ƒ' : 'è¬ç¾å…ƒ' }}</div>
                                    </div>
                                    <button @click.stop="deleteSavedGoal(index)" class="text-gray-500 hover:text-error transition-colors"><i class="mdi mdi-delete"></i></button>
                                </div>
                                <div class="mt-3">
                                    <div class="flex justify-between text-xs text-gray-400 mb-1">
                                        <span>ç•¶å‰: {{ (goal.currentAssets).toLocaleString() }}è¬ç¾å…ƒ</span>
                                        <span>ç›®æ¨™: {{ formatCurrency(getCalculatedTargetAmount(goal), goal.goalType) }}</span>
                                    </div>
                                    <div class="w-full bg-surface rounded-full h-1.5"><div class="bg-success h-1.5 rounded-full" :style="{width: calculateGoalProgress(goal) + '%'}"></div></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <h2 class="text-2xl font-bold mb-6">{{ pageTitle }} - åŸºæœ¬è¨­å®š</h2>
                    <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                        <div class="lg:col-span-4 space-y-6">
                            <div class="rounded-lg">
                                <div class="space-y-4">
                                    <div><label class="text-sm text-gray-400">é¸æ“‡è²¡å‹™ç›®æ¨™</label><select v-model="form.goalType" class="w-full p-2 mt-1 bg-surface border border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-primary"><option v-for="opt in goalOptions" :value="opt.value">{{ opt.text }}</option></select></div>
                                    <div>
                                        <label class="text-sm text-gray-400">{{ targetCurrentAge }}</label>
                                        <input v-model.number="form.currentAge" type="number" step="0.01" class="w-full p-2 mt-1 bg-surface border border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-primary">
                                        <p v-if="formErrors.currentAge" class="text-error text-xs mt-1">{{ formErrors.currentAge }}</p>
                                    </div>
                                    <div>
                                        <label class="text-sm text-gray-400">{{ targetAgeLabel }}</label>
                                        <input v-model.number="form.targetAge" type="number" step="0.01" class="w-full p-2 mt-1 bg-surface border border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-primary">
                                        <p v-if="formErrors.targetAge" class="text-error text-xs mt-1">{{ formErrors.targetAge }}</p>
                                    </div>
                                    <div><label class="text-sm text-gray-400">{{ targetAmountLabel }}</label><input v-model.number="form.targetValue" type="number" class="w-full p-2 mt-1 bg-surface border border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-primary"></div>
                                    <div><label class="text-sm text-gray-400">ç•¶å‰ç¸½è³‡ç”¢ (è¬ç¾å…ƒ)</label><input v-model.number="form.currentAssets" type="number" class="w-full p-2 mt-1 bg-surface border border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-primary"></div>
                                    <div><label class="text-sm text-gray-400">{{ monthlyInvestmentLabel }}</label><input v-model.number="form.monthlyInvestment" type="number" class="w-full p-2 mt-1 bg-surface border border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-primary"></div>
                                    <div><label class="text-sm text-gray-400">é¸æ“‡æŠ•è³‡ç­–ç•¥</label><select v-model="form.strategyReturn" class="w-full p-2 mt-1 bg-surface border border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-primary"><option v-for="opt in strategyOptions" :value="opt.value">{{ opt.text }}</option></select></div>
                                    <button @click="calculate" class="w-full bg-primary hover:bg-primary-hover text-white font-bold py-3 px-4 rounded-md transition-colors">{{ calculateButtonText }}</button>
                                </div>
                            </div>
                        </div>

                        <div class="lg:col-span-8">
                            <transition enter-active-class="transition ease-out duration-300" enter-from-class="opacity-0" enter-to-class="opacity-100" leave-active-class="transition ease-in duration-200" leave-from-class="opacity-100" leave-to-class="opacity-0">
                                <div v-if="results.show">
                                    <div class="flex justify-between items-center mb-4">
                                        <h2 class="text-2xl font-bold">{{ resultsTitle }}</h2>
                                        <button @click="saveGoal" :disabled="!isLoggedIn" class="flex items-center gap-2 px-4 py-2 rounded-md text-sm font-semibold transition-colors" :class="isLoggedIn ? 'bg-success/20 text-success hover:bg-success/30' : 'bg-gray-700 text-gray-400 cursor-not-allowed'">
                                            <i class="mdi mdi-content-save"></i> {{ isLoggedIn ? 'å„²å­˜ç›®æ¨™' : 'ç™»å…¥å¾Œå¯å„²å­˜' }}
                                        </button>
                                    </div>
                                    <div class="bg-background rounded-lg p-2 mb-6"><div id="customChart" v-html="chartHTML"></div></div>
                                    <div class="p-4 rounded-lg border-l-4" :class="results.isGoalAchieved ? 'bg-success/10 border-success' : 'bg-warning/10 border-warning'">
                                        <div class="flex-col">
                                            <i class="mdi text-3xl mb-3" :class="results.isGoalAchieved ? 'mdi-check-circle text-success' : 'mdi-alert-circle text-warning'"></i>
                                            <div>
                                                <h3 class="font-bold text-lg mb-1">{{ results.isGoalAchieved ? 'ç›®å‰ç­–ç•¥å¯é”æˆç›®æ¨™ï¼' : 'ç›®å‰ç­–ç•¥ç„¡æ³•é”æˆç›®æ¨™' }}</h3>
                                                <p>é è¨ˆé”æˆæ™‚è³‡ç”¢ï¼š<strong>{{ formatCurrency(results.finalAsset, form.goalType) }}</strong></p>
                                                <div v-if="!results.isGoalAchieved">
                                                    <p>ç›®æ¨™é‡‘é¡ï¼š<strong>{{ formatCurrency(results.goalAmount, form.goalType) }}</strong></p>
                                                    <p>è³‡é‡‘ç¼ºå£ï¼š<strong>{{ formatCurrency(results.goalAmount - results.finalAsset, form.goalType) }}</strong></p>
                                                    <hr class="border-gray-600 my-3">
                                                    <p class="font-semibold mb-3">æ ¹æ“šè¨ˆç®—çµæœï¼Œå¦‚æƒ³åœ¨ç›®æ¨™æœŸå…§é”æˆç›®æ¨™ï¼Œå¯é¸æ“‡ï¼š</p>
                                                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                                        <div class="bg-secondary/50 p-4 rounded-lg"><div class="text-sm text-gray-300">å°‡å¹´åŒ–å ±é…¬ç‡æé«˜è‡³</div><div class="text-2xl font-bold">{{ results.requiredReturn.toFixed(1) }}%</div></div>
                                                        <div class="bg-primary/50 p-4 rounded-lg">
                                                            <div class="text-sm text-gray-300">å°‡æ¯æœˆæŠ•è³‡é‡‘é¡æé«˜è‡³</div>
                                                            <div class="text-2xl font-bold">{{ results.requiredInvestment.toLocaleString(undefined, { maximumFractionDigits: 0 }) }} {{ form.goalType === 'retirement' ? 'ç¾å…ƒ' : 'è¬å…ƒ' }}</div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div v-else class="flex flex-col items-center justify-center h-full text-center text-gray-500">
                                    <i class="mdi mdi-chart-line text-6xl"></i>
                                    <p class="mt-4">è«‹è¼¸å…¥æ‚¨çš„è²¡å‹™ç›®æ¨™ä¸¦é»æ“Šè¨ˆç®—</p>
                                </div>
                            </transition>
                        </div>
                    </div>
                    
                    <transition enter-active-class="transition ease-out duration-300" enter-from-class="opacity-0" enter-to-class="opacity-100">
                        <div v-if="results.show" class="mt-8">
                            <h3 class="text-xl text-center font-bold mb-4">ğŸ’¡ ç­–ç•¥æŠ•è³‡çµ„åˆå»ºè­°</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                <div v-for="rec in recommendationResults" :key="rec.name" class="bg-surface rounded-lg p-4 cursor-pointer transition-all duration-300 hover:scale-105 hover:shadow-lg border-2" :class="rec.isBest ? 'border-primary/50 bg-primary/50' : 'border-transparent'" @click="selectStrategy(rec.name)">
                                    <div class="flex justify-between items-center mb-2">
                                        <h4 class="font-bold text-lg">{{ rec.name }}</h4>
                                        <span class="text-sm font-semibold bg-primary text-white px-2 py-0.5 rounded-full">{{ (rec.expectedReturn * 100).toFixed(1) }}%</span>
                                    </div>
                                    <p class="text-xs text-gray-400 mb-3">{{ rec.reason }}</p>
                                    <div v-if="rec.isMetByInitial" class="font-bold text-success text-sm">âœ”ï¸ ç¾æœ‰æœˆæŠ•é‡‘é¡è¶³ä»¥é”æˆç›®æ¨™</div>
                                    <div v-else class="font-bold text-sm bg-primary-gradient text-white-hover p-2 rounded-md">å¯æ­é…æœˆæŠ•ï¼šUSD$ {{ rec.requiredMonthly.toLocaleString() }}</div>
                                </div>
                            </div>
                        </div>
                    </transition>
                    
                </main>
            </div>
        </div>

        <transition enter-active-class="transition ease-out duration-300" enter-from-class="transform opacity-0 -translate-y-4" enter-to-class="transform opacity-100 translate-y-0" leave-active-class="transition ease-in duration-200" leave-from-class="transform opacity-100 translate-y-0" leave-to-class="transform opacity-0 -translate-y-4">
            <div v-if="snackbar.show" class="fixed top-5 right-5 p-4 rounded-md shadow-lg text-white font-semibold" :class="{ 'bg-success': snackbar.color === 'success', 'bg-error': snackbar.color === 'error', 'bg-warning': snackbar.color === 'warning', 'bg-blue-500': snackbar.color === 'info' }">
                {{ snackbar.message }}
            </div>
        </transition>
    </div>

<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
<script>
    // Loading management
    document.addEventListener('DOMContentLoaded', function() {
        setTimeout(() => {
            const loadingOverlay = document.getElementById('loadingOverlay');
            const app = document.getElementById('app');
            loadingOverlay.style.opacity = '0';
            app.style.opacity = '1';
            setTimeout(() => { loadingOverlay.style.display = 'none'; }, 500);
        }, 1500);
    });

    // --- FIX START ---
    // 1. ç¢ºä¿ onMounted è¢«æ­£ç¢ºå¼•å…¥
    const { createApp, ref, computed, watch, nextTick, onMounted } = Vue;
    // --- FIX END ---

    const app = createApp({
        setup() {
            const isMenuOpen = ref(false);
            const toggleMenu = () => { isMenuOpen.value = !isMenuOpen.value; };

            const API_BASE_URL = 'https://49d22ce3-d235-4200-af2b-da55a826dee9.mock.pstmn.io/forms';
            const AUTH_TOKEN = 'Bearer eyJhbGciOiJSUzI1NiIsImtpZCI6IldBRktTTVptVmN6YzVGckdqTlBOT090emZudmE5RDNvIiwidHlwIjoiSldUIn0.eyJzdWIiOiI0NzExMjIyIiwidXNlcl9ndWlkIjoiMDg4ZmIwOWMtNWE1Yy00MTQ6LWI2NjctODFlNmVmZjJhMzU5IiwidG9rZW5faWQiOiIxMSIsImFwcF9pZCI6IjIxIiwiaXNfZ3Vlc3QiOmZhbHNlLCJuYmYiOjE3NTc1NjgxODgsImV4cCI6MTc1NzY1ODE4OCwiaWF0IjoxNzU3NTcxNzg4LCJpc3MiOiJodHRwczovL3d3dy5jbW9uZXkudHciLCJhdWQiOiJjbW9uZXlhcGkifQ.mKdSX-Cff2itAIdK66eL4Tj5XVxNS66frMAjzVBFrjGJuI_ZHX6dg77kkX07PTjPBZ02FsBUbJanH0WjXN18KAI4VBV0BvV71GgQ4NSeNSG9gO6N7DxTifAxfrZ94xhjZuixs-x2xOl0kCoWHA3AODvA5D2uCyBPD599C9oHlYKSoqC9fW6-wHmN3oJOe6tXnNYDNYLSC6IbKPXppX2Jp2zQqjWsVdTRYh-JQcGoERBiX6ctyn7pK4ExXh8kBP3BuST2eEZEiTU70ED7AFa_FpOoDHoPfaCa0iSIEPVyX6riSezHqA_4yKaUu1ceb3fAX-lvnFeoD2L4MA2eWODHAw';

            const defaultGoalTypes = { 
                retirement: { key: 'retirement', title: "é€€ä¼‘è¦åŠƒ", CurrentAge:"ç›®å‰å¹´é½¡", ageLabel: "é è¨ˆé€€ä¼‘å¹´é½¡", amountLabel: "æ¯æœˆæœŸæœ›é€€ä¼‘è¢«å‹•æ”¶å…¥(ç¾å…ƒ)", withdrawRate: 0.04, formId: 3 }, 
                house: { key: 'house', title: "è³¼å±‹è¨ˆç•«", CurrentAge:"ç›®å‰å¹´é½¡", ageLabel: "é è¨ˆè³¼å±‹å¹´é½¡", amountLabel: "ç›®æ¨™æˆ¿å±‹ç¸½åƒ¹(è¬ç¾å…ƒ)", withdrawRate: 1.0,formId: 4 }, 
                education: { key: 'education', title: "æ•™è‚²åŸºé‡‘", CurrentAge:"å­©å­ç›®å‰å¹´é½¡", ageLabel: "å­©å­é è¨ˆå…¥å­¸å¹´é½¡", amountLabel: "é ä¼°æ•™è‚²ç¸½è²»ç”¨(è¬ç¾å…ƒ)", withdrawRate: 1.0, formId: 5 }, 
                emergency: { key: 'emergency', title: "ç·Šæ€¥é å‚™é‡‘", CurrentAge:"ç›®å‰å¹´é½¡", ageLabel: "é è¨ˆå®Œæˆå¹´é½¡", amountLabel: "ç·Šæ€¥é å‚™é‡‘ç›®æ¨™(è¬ç¾å…ƒ)", withdrawRate: 1.0, formId: 6 }, 
                custom: { key: 'custom', title: "è‡ªå®šç¾©ç›®æ¨™", CurrentAge:"ç›®å‰å¹´é½¡", ageLabel: "é è¨ˆé”æˆå¹´é½¡", amountLabel: "ç›®æ¨™é‡‘é¡(è¬ç¾å…ƒ)", withdrawRate: 1.0, formId: 7 } 
            };
            const goalTypes = ref({});

            const inflationRate = 0.03;
            const strategies = { 
                'å…¨å¤©å€™ç­–ç•¥': { expectedReturn: 0.05, volatility: 0.67, allocation: { 'VTI': 30, 'TLT': 40, 'IEF': 15, 'GLD': 7.5, 'DBC': 7.5 } }, 
                'ä¸‰åŸºé‡‘çµ„åˆ': { expectedReturn: 0.08, volatility: 0.76, allocation: { 'VTI (ç¾åœ‹è‚¡å¸‚)': 60, 'VTIAX (åœ‹éš›è‚¡å¸‚)': 20, 'BND (å‚µåˆ¸)': 20 } }, 
                'ç©æ¥µå‹è‚¡å‚µçµ„åˆ': { expectedReturn: 0.099, volatility: 0.6, allocation: { 'VTI (ç¾åœ‹è‚¡å¸‚)': 70, 'VTIAX (åœ‹éš›è‚¡å¸‚)': 10, 'BND (å‚µåˆ¸)': 20 } },
                'æ ¸å¿ƒå››åŸºé‡‘': { expectedReturn: 0.1, volatility: 0.71, allocation: { 'VTI (ç¾åœ‹è‚¡å¸‚)': 50, 'VXUS': 20, 'VNQ':10,'BND (å‚µåˆ¸)': 20 } },
                'å·´è²ç‰¹æ¨è–¦': { expectedReturn: 0.128, volatility: 0.82, allocation: { 'VOO': 100} } 
            };
            const strategyReasons = { 
                'å…¨å¤©å€™ç­–ç•¥': 'æ­¤ç­–ç•¥æä¾›è‰¯å¥½çš„é¢¨éšªåˆ†æ•£ï¼Œé©åˆè¿½æ±‚ç©©å®šå ±é…¬çš„æŠ•è³‡è€…', 
                'ä¸‰åŸºé‡‘çµ„åˆ': 'ç°¡å–®è€Œæœ‰æ•ˆçš„é…ç½®ï¼Œé©åˆé•·æœŸæŠ•è³‡ä¸”å¸Œæœ›é™ä½ç®¡ç†è¤‡é›œåº¦çš„æŠ•è³‡è€…', 
                'ç©æ¥µå‹è‚¡å‚µçµ„åˆ': 'è¼ƒé«˜çš„è‚¡ç¥¨é…ç½®èƒ½å¸¶ä¾†æ›´å¥½çš„é•·æœŸå ±é…¬ï¼Œé©åˆå¹´è¼•ä¸”é¢¨éšªæ‰¿å—åº¦é«˜çš„æŠ•è³‡è€…',
                'æ ¸å¿ƒå››åŸºé‡‘': 'ã€Œä¸‰åŸºé‡‘çµ„åˆã€çš„é€²éšé¸é …ï¼Œå¢åŠ æˆ¿åœ°ç”¢ä»¥å°æŠ—é€šè†¨ã€‚', 
                'å·´è²ç‰¹æ¨è–¦': 'å®Œå…¨ç›¸ä¿¡ä¸¦æŠ¼æ³¨æ–¼ç¾åœ‹æœ€å…·ä»£è¡¨æ€§çš„ 500 å®¶é ‚ç´šä¼æ¥­çš„é•·æœŸå¢é•·ã€‚'  
            };

            const form = ref({ goalType: 'retirement', currentAge: 25, targetAge: 65, targetValue: 5000, currentAssets: 100, monthlyInvestment: 1000, strategyReturn: 0.05});
            const formErrors = ref({});
            const results = ref({ show: false });
            const chartHTML = ref('');
            const recommendationResults = ref([]);
            const savedGoals = ref([]);
            const isLoggedIn = ref(true); 
            const snackbar = ref({ show: false, message: '', color: 'success' });

            const showSnackbar = (message, color = 'success', duration = 3000) => {
                snackbar.value = { show: true, message, color };
                setTimeout(() => { snackbar.value.show = false; }, duration);
            };

            const loadFormDefinitions = async () => {
                try {
                    console.log("æ­£åœ¨å˜—è©¦å¾ API ç²å–æœ€æ–°çš„è¡¨å–®å®šç¾©...");
                    const response = await fetch(API_BASE_URL, {
                        method: 'GET',
                        headers: { 'Authorization': AUTH_TOKEN, 'accept': 'application/json' }
                    });
                    if (!response.ok) throw new Error(`API å›æ‡‰ä¸æ­£ç¢º: ${response.statusText}`);
                    const formsArray = await response.json();
                    if (!Array.isArray(formsArray) || formsArray.length === 0) throw new Error("API å›å‚³çš„è³‡æ–™æ ¼å¼ä¸ç¬¦æˆ–ç‚ºç©º");
                    const newGoalTypes = {};
                    for (const formDef of formsArray) { newGoalTypes[formDef.key] = formDef; }
                    goalTypes.value = newGoalTypes;
                    console.log("æˆåŠŸå¾ API ç²å–è¡¨å–®å®šç¾©:", goalTypes.value);
                } catch (error) {
                    console.error('å¾ API ç²å–è¡¨å–®å®šç¾©å¤±æ•—:', error);
                    console.warn('API ç²å–å¤±æ•—ï¼Œå°‡ä½¿ç”¨å‰ç«¯çš„é è¨­è³‡æ–™ã€‚');
                    goalTypes.value = defaultGoalTypes;
                }
            };

            const loadGoalsFromAPI = async () => {
                if (Object.keys(goalTypes.value).length === 0) return;
                const formIds = Object.values(goalTypes.value).map(g => g.formId);
                const fetchPromises = formIds.map(async (formId) => {
                    try {
                        const response = await fetch(`${API_BASE_URL}/${formId}`, {
                            headers: { 'Authorization': AUTH_TOKEN, 'accept': 'application/json' }
                        });
                        if (response.ok) {
                            const data = await response.json();
                            if (data && data.goalType) return data;
                        } else if (response.status !== 404) {
                            console.error(`Error fetching goal for formId ${formId}:`, response.statusText);
                        }
                        return null;
                    } catch (error) {
                        console.error(`Network error fetching goal for formId ${formId}:`, error);
                        return null;
                    }
                });
                try {
                    const results = await Promise.all(fetchPromises);
                    savedGoals.value = results.filter(goal => goal !== null);
                } catch (error) {
                    showSnackbar('è®€å–å·²å­˜ç›®æ¨™å¤±æ•—', 'error');
                    console.error('Error loading all goals:', error);
                }
            };

            onMounted(async () => {
                await loadFormDefinitions();
                loadGoalsFromAPI();
            });

            // --- FIX START ---
            // 2. è®“ computed å±¬æ€§æ›´å¥å£¯ï¼Œä»¥é˜²è³‡æ–™å°šæœªè¼‰å…¥
            const currentGoalConfig = computed(() => goalTypes.value[form.value.goalType] || {});
            const pageTitle = computed(() => `${currentGoalConfig.value.title || 'è²¡å‹™è¦åŠƒ'}å·¥å…·`);
            const targetCurrentAge = computed(() => currentGoalConfig.value.CurrentAge || 'ç›®å‰å¹´é½¡');
            const targetAgeLabel = computed(() => currentGoalConfig.value.ageLabel || 'ç›®æ¨™å¹´é½¡');
            const targetAmountLabel = computed(() => currentGoalConfig.value.amountLabel || 'ç›®æ¨™é‡‘é¡');
            const resultsTitle = computed(() => `${currentGoalConfig.value.title || ''}åˆ†æçµæœ`);
            const calculateButtonText = computed(() => `è¨ˆç®—${currentGoalConfig.value.title || ''}`);
            const goalOptions = computed(() => {
                return Object.keys(goalTypes.value).map(key => ({ 
                    text: goalTypes.value[key].title, 
                    value: key 
                }));
            });
            // --- FIX END ---
            
            const monthlyInvestmentLabel = computed(() => form.value.goalType === 'retirement' ? 'æ¯æœˆæŠ•è³‡é‡‘é¡ (ç¾å…ƒ)' : 'æ¯æœˆæŠ•è³‡é‡‘é¡ (è¬ç¾å…ƒ)');
            const strategyOptions = [ { text: 'æ¥µä¿å®ˆå‹ - å¹´åŒ–æ³¢å‹• < 5% ', value: 0.05 }, { text: 'ç©©å¥å‹ - ä¸‰åŸºé‡‘çµ„åˆ (8%)', value: 0.08 }, { text: 'ç©æ¥µå‹ - ç©æ¥µå‹è‚¡å‚µ (9.9%)', value: 0.099 }, { text: 'å¢é•·å‹ - æ ¸å¿ƒå››åŸºé‡‘ (8.6%)', value: 0.086 }, { text: 'é«˜é¢¨éšªå‹ - å·´è²ç‰¹æ¨è–¦ (12.8%)', value: 0.128 } ];
            
            watch(() => form.value.goalType, (newType) => { 
                results.value.show = false; 
                if (newType === 'retirement') {
                    form.value.targetValue = 5000;
                    form.value.monthlyInvestment = 1000;
                } else {
                    form.value.targetValue = 500;
                    form.value.monthlyInvestment = 1;
                }
            });
            watch(() => form.value.currentAge, (val) => {
                if (val > 120) formErrors.value.currentAge = 'å¹´é½¡ä¸èƒ½è¶…é120æ­²';
                else if (val < 0) formErrors.value.currentAge = 'å¹´é½¡ä¸èƒ½æ˜¯è² æ•¸';
                else delete formErrors.value.currentAge;
            });
            watch(() => form.value.targetAge, (val) => {
                if (val > 120) formErrors.value.targetAge = 'å¹´é½¡ä¸èƒ½è¶…é120æ­²';
                else if (val < 0) formErrors.value.targetAge = 'å¹´é½¡ä¸èƒ½æ˜¯è² æ•¸';
                else delete formErrors.value.targetAge;
            });
            
            const showTooltip = (event, content) => { const el = document.getElementById('chartTooltip'); if (el) { el.innerHTML = content; el.classList.add('visible'); moveTooltip(event); } };
            const moveTooltip = (event) => { const el = document.getElementById('chartTooltip'); if (el) { const rect = el.getBoundingClientRect(); el.style.left = `${event.pageX - (rect.width / 2)}px`; el.style.top = `${event.pageY - rect.height - 15}px`; } };
            const hideTooltip = () => { const el = document.getElementById('chartTooltip'); if (el) el.classList.remove('visible'); };
            
            const saveGoal = async () => {
                if (!isLoggedIn.value) { showSnackbar('è«‹å…ˆç™»å…¥æ‰èƒ½å„²å­˜ç›®æ¨™', 'warning'); return; }
                const formId = goalTypes.value[form.value.goalType]?.formId;
                if (!formId) { showSnackbar('ç„¡æ•ˆçš„ç›®æ¨™é¡å‹', 'error'); return; }
                const answersArray = Object.entries(form.value).map(([key, value]) => ({ questionId: key, answers: [{ value: String(value) }] }));
                const requestBody = { answers: answersArray };
                const apiUrl = `${API_BASE_URL}/${formId}/responses`;
                try {
                    const response = await fetch(apiUrl, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(requestBody),
                    });
                    if (!response.ok) { throw new Error(`API è«‹æ±‚å¤±æ•—: ${response.statusText}`); }
                    const goalData = { ...form.value, savedAt: new Date().toISOString() };
                    const existingIndex = savedGoals.value.findIndex(g => g.goalType === goalData.goalType);
                    if (existingIndex !== -1) { savedGoals.value[existingIndex] = goalData; } 
                    else { savedGoals.value.push(goalData); }
                    showSnackbar('ç›®æ¨™å·²å„²å­˜ï¼', 'success');
                } catch (error) {
                    console.error('å„²å­˜ç›®æ¨™å¤±æ•—:', error);
                    showSnackbar('å„²å­˜ç›®æ¨™å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
                }
            };

            const loadSavedGoal = (goal) => {
                form.value = { ...goal };
                nextTick(() => { calculate(); showSnackbar('å·²è¼‰å…¥ç›®æ¨™ä¸¦é‡æ–°è¨ˆç®—', 'info'); });
            };

            const deleteSavedGoal = async (index) => {
                const goalToDelete = savedGoals.value[index];
                const formId = goalTypes.value[goalToDelete.goalType]?.formId;
                if (!formId) { showSnackbar('ç„¡æ³•åˆªé™¤ï¼šç„¡æ•ˆçš„ç›®æ¨™é¡å‹', 'error'); return; }
                const apiUrl = `${API_BASE_URL}/${formId}?mock_server_example_key=form_found_result`;
                try {
                    const response = await fetch(apiUrl, { method: 'DELETE' });
                    if (!response.ok) { throw new Error(`API åˆªé™¤å¤±æ•—: ${response.statusText}`); }
                    savedGoals.value.splice(index, 1);
                    showSnackbar('ç›®æ¨™å·²åˆªé™¤', 'success');
                } catch (error) {
                    console.error('åˆªé™¤ç›®æ¨™æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                    showSnackbar('åˆªé™¤å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
                }
            };
            
            // --- Calculation and Rendering Functions (ä¿æŒä¸è®Š) ---
            const formatCurrency = (value, goalType) => { if (goalType === 'retirement') { return `${Math.round(value).toLocaleString()} ç¾å…ƒ`; } return `${Math.round(value / 10000).toLocaleString()} è¬ç¾å…ƒ`; };
            const getCalculatedTargetAmount = (goal) => { const config = goalTypes.value[goal.goalType]; const years = goal.targetAge - goal.currentAge; if (years <= 0) return goal.goalType === 'retirement' ? goal.targetValue : goal.targetValue * 10000; const targetValueUSD = goal.goalType === 'retirement' ? goal.targetValue : goal.targetValue * 10000; if (config && config.withdrawRate === 0.04) { let base = (targetValueUSD * 12 / config.withdrawRate); return Math.round(base * Math.pow(1 + inflationRate, years)); } return targetValueUSD; };
            const calculateGoalProgress = (goal) => { const targetAmount = getCalculatedTargetAmount(goal); if (targetAmount <= 0) return 0; const currentAssetsUSD = goal.currentAssets * 10000; return Math.min((currentAssetsUSD / targetAmount) * 100, 100); };
            const projectAssets = (years, annualReturn, monthlyInvestUSD, currentAssetsUSD) => { const projection = [currentAssetsUSD]; for (let year = 1; year <= years; year++) { let totalAssets = currentAssetsUSD * Math.pow(1 + annualReturn, year); if (annualReturn > 0) { totalAssets += (monthlyInvestUSD * 12) * ((Math.pow(1 + annualReturn, year) - 1) / annualReturn); } else { totalAssets += (monthlyInvestUSD * 12 * year); } projection.push(totalAssets); } return projection; };
            const calculateAccumulatedInvestment = (years, monthlyInvestUSD, currentAssetsUSD) => { const accumulated = [currentAssetsUSD]; for (let i = 1; i <= years; i++) { accumulated.push(currentAssetsUSD + (monthlyInvestUSD * 12 * i)); } return accumulated; };
            const calculate = () => { if (Object.keys(formErrors.value).length > 0) { showSnackbar('è«‹ä¿®æ­£è¡¨å–®ä¸­çš„éŒ¯èª¤', 'error'); return; } if (form.value.targetAge <= form.value.currentAge) { showSnackbar('ç›®æ¨™å¹´é½¡å¿…é ˆå¤§æ–¼ç›®å‰å¹´é½¡', 'error'); return; } const years = form.value.targetAge - form.value.currentAge; const isRetirement = form.value.goalType === 'retirement'; const goalAmount = getCalculatedTargetAmount(form.value); const monthlyInvestUSD = isRetirement ? form.value.monthlyInvestment : form.value.monthlyInvestment * 10000; const currentAssetsUSD = form.value.currentAssets * 10000; const assetsProjection = projectAssets(years, form.value.strategyReturn, monthlyInvestUSD, currentAssetsUSD); const investmentProjection = calculateAccumulatedInvestment(years, monthlyInvestUSD, currentAssetsUSD); const finalAsset = assetsProjection[assetsProjection.length - 1]; results.value = { show: true, isGoalAchieved: finalAsset >= goalAmount, finalAsset, goalAmount, years }; if (!results.value.isGoalAchieved) { results.value.requiredReturn = calcRequiredReturn(goalAmount, years, monthlyInvestUSD, currentAssetsUSD); results.value.requiredInvestment = calcRequiredInvestment(goalAmount, years, currentAssetsUSD); } updateStrategyRecommendations(goalAmount, years, currentAssetsUSD); renderCustomChart(assetsProjection, investmentProjection, goalAmount, years); };
            const calcRequiredReturn = (target, years, monthlyInvestUSD, startAssetsUSD) => { let low = 0, high = 0.5; for (let i = 0; i < 100; i++) { const mid = (low + high) / 2; let val = startAssetsUSD * Math.pow(1 + mid, years); if (mid > 0) val += (monthlyInvestUSD * 12) * ((Math.pow(1 + mid, years) - 1) / mid); else val += (monthlyInvestUSD * 12 * years); if (val > target) high = mid; else low = mid; } return low * 100; };
            const calcRequiredInvestment = (target, years, startAssetsUSD) => { const r = form.value.strategyReturn; const fvCurrent = startAssetsUSD * Math.pow(1 + r, years); const needed = target - fvCurrent; if (needed <= 0) return 0; let requiredMonthlyUSD; if (r > 0) requiredMonthlyUSD = needed / (((Math.pow(1 + r, years) - 1) / r) * 12); else requiredMonthlyUSD = needed / (years * 12); return form.value.goalType === 'retirement' ? requiredMonthlyUSD : requiredMonthlyUSD / 10000; };
            const calculateRequiredMonthlyInvestmentForStrategy = (targetAmount, years, annualReturn, startAssetsUSD) => { const fvCurrent = startAssetsUSD * Math.pow(1 + annualReturn, years); const remainingNeeded = targetAmount - fvCurrent; if (remainingNeeded <= 0) return { amount: 0, isMetByInitial: true }; let requiredMonthlyUSD = 0; if (annualReturn > 0) requiredMonthlyUSD = remainingNeeded / (((Math.pow(1 + annualReturn, years) - 1) / annualReturn) * 12); else requiredMonthlyUSD = remainingNeeded / (years * 12); return { amount: requiredMonthlyUSD, isMetByInitial: false }; };
            const updateStrategyRecommendations = (goalAmount, years, currentAssetsUSD) => { const recommendations = Object.entries(strategies).map(([name, strategy]) => { const calcResult = calculateRequiredMonthlyInvestmentForStrategy(goalAmount, years, strategy.expectedReturn, currentAssetsUSD); return { name, strategy, requiredMonthly: calcResult.amount, isMetByInitial: calcResult.isMetByInitial }; }); const bestStrategy = recommendations.reduce((best, current) => { return current.requiredMonthly < best.requiredMonthly ? current : best; }, recommendations[0]); recommendationResults.value = recommendations.map(rec => ({ name: rec.name, expectedReturn: rec.strategy.expectedReturn, requiredMonthly: Math.round(rec.requiredMonthly), reason: strategyReasons[rec.name], isBest: rec.name === bestStrategy.name, isMetByInitial: rec.isMetByInitial })); };
            const selectStrategy = (strategyName) => { const selected = strategies[strategyName]; if (!selected) return; const closest = strategyOptions.reduce((p, c) => Math.abs(c.value - selected.expectedReturn) < Math.abs(p.value - selected.expectedReturn) ? c : p); form.value.strategyReturn = closest.value; if (results.value.show) calculate(); };
            const renderCustomChart = (assetsProjection, investmentProjection, goal, totalYears) => { const maxValue = Math.max(goal, ...assetsProjection); const generateChartYears = (total) => { const years = [0, 1]; let i = 5; if (total > 30) i = 10; if (total > 60) i = 15; for (let y = i; y <= total; y += i) if (!years.includes(y)) years.push(y); if (!years.includes(total) && total > 1) years.push(total); return years.sort((a, b) => a - b).filter((y, i, a) => i === 0 || y > a[i-1]); }; const chartYears = generateChartYears(totalYears); const legendHTML = `<div class="chart-legend"><div class="legend-item"><div class="legend-color" style="background: linear-gradient(to top, #3182ce 0%, #4299e1 100%);"></div><span>ç´¯ç©æŠ•è³‡æˆæœ¬</span></div><div class="legend-item"><div class="legend-color" style="background: linear-gradient(to top, #208065 0%, #40A080 100%);"></div><span>æŠ•è³‡å¢é•·æ”¶ç›Š</span></div></div>`; let barsHTML = chartYears.map(year => { if(year > totalYears) return ''; const totalAsset = assetsProjection[year] || 0; const totalInvestment = investmentProjection[year] || 0; const growth = Math.max(0, totalAsset - totalInvestment); const totalHeightPercent = maxValue > 0 ? (totalAsset / maxValue) * 100 : 0; const investmentHeightPercent = totalAsset > 0 ? (totalInvestment / totalAsset) * 100 : 0; const growthHeightPercent = totalAsset > 0 ? (growth / totalAsset) * 100 : 0; const tooltipContent = `<strong>ç¸½è³‡ç”¢:</strong> ${formatCurrency(totalAsset, form.value.goalType)}<br><strong>ç´¯ç©æŠ•è³‡æˆæœ¬:</strong> ${formatCurrency(totalInvestment, form.value.goalType)}<br><strong>æŠ•è³‡å¢é•·æ”¶ç›Š:</strong> ${formatCurrency(growth, form.value.goalType)}`; return `<div class="bar" style="height: ${totalHeightPercent}%;" onmouseover='window.appInstance.showTooltip(event, "${tooltipContent}")' onmousemove="window.appInstance.moveTooltip(event)" onmouseout="window.appInstance.hideTooltip()"> <div class="bar-value">${formatCurrency(totalAsset, form.value.goalType)}</div> <div class="bar-segment growth" style="height: ${growthHeightPercent}%;"></div> <div class="bar-segment investment" style="height: ${investmentHeightPercent}%;"></div> </div>`; }).join(''); const goalLineBottomPercent = Math.min(maxValue > 0 ? (goal / maxValue) * 100 : 0, 95); let labelsHTML = chartYears.map(year => year === 0 ? `<div class="bar-label">èµ·å§‹é‡‘é¡</div>` : `<div class="bar-label"><span class="year-text">${year}å¹´å¾Œ</span><span class="age-text">(${form.value.currentAge + year}æ­²)</span></div>`).join(''); chartHTML.value = `${legendHTML} <div class="bar-chart"> <div class="bars-container"> <div class="goal-line" style="bottom: ${goalLineBottomPercent}%;"> <div class="goal-label">ç›®æ¨™ ${formatCurrency(goal, form.value.goalType)}</div> </div> ${barsHTML} </div> <div class="labels-container">${labelsHTML}</div> </div>`; };

            return { 
                form, formErrors, results, chartHTML, recommendationResults, savedGoals, isLoggedIn, snackbar,
                goalTypes, pageTitle, targetCurrentAge, targetAgeLabel, targetAmountLabel, monthlyInvestmentLabel, resultsTitle, 
                calculateButtonText, goalOptions, strategyOptions, calculate, selectStrategy,
                saveGoal, loadSavedGoal, deleteSavedGoal, showTooltip, moveTooltip, hideTooltip,
                getCalculatedTargetAmount, calculateGoalProgress, isMenuOpen, toggleMenu, formatCurrency
            };
        }
    });
    
    const vm = app.mount('#app');
    window.appInstance = vm;
</script>
    
</body>
</html>