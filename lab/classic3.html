<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
  <title>投資組合回測 - 三基金組合</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <link rel="stylesheet" href="src/style.css">
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>投資組合回測</h1>
      <div class="tab-buttons">
        <a href="all_weather.html" class="tab-button">全天候策略</a>
        <a href="classic3.html" class="tab-button active">三基金組合</a>
        <a href="aggressive.html" class="tab-button">積極型股債組合</a>
      </div>
    </div>

    <div class="two-column">
      <div class="performance-section row">
        <div class="performance-row col-12">
          <div class="card dark1 col-6">
            <div class="metric-label">報酬</div>
            <div class="metric-card">
              <div class="metric-label">年化報酬率（估）</div>
              <div class="metric-value" id="annualReturn">8.1%</div>
            </div>
            <div class="metric-card" style="margin-top:12px;">
              <div class="metric-label">總報酬率（估）</div>
              <div class="metric-value" id="totalReturnPct">0.0%</div>
            </div>
          </div>
          <div class="card dark1 col-6">
            <div class="metric-label">風險（估）</div>
            <div class="metric-card">
              <div class="metric-label">年化波動率</div>
              <div class="metric-value" id="volatility">10.5%</div>
            </div>
            <div class="metric-card" style="margin-top:8px;">
              <div class="metric-label">最大回撤</div>
              <div class="metric-value" id="maxDrawdown">-33.0%</div>
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <h2 class="chart-title">組成標的與比例</h2>
        <div class="allocation-display">
          <div class="pie-chart-container">
            <canvas id="pieChart"></canvas>
          </div>
          <div id="allocationLegend" class="allocation-legend"></div>
        </div>
      </div>
    </div>

    <div class="card dark2">
      <div class="inline-controls" style="justify-content:space-between; margin-bottom:8px;">
        <div class="inline-controls">
          <div class="chart-title">歷史回測（與 S&P 500 比較）</div>
          <button class="chip backtest-years active" data-years="3">近 3 年</button>
          <button class="chip backtest-years" data-years="5">近 5 年</button>
          <button class="chip backtest-years" data-years="10">近 10 年</button>
        </div>
        <div class="switch" title="股利處理方式">
          <label style="font-size:12px; opacity:.8;">股利處理：</label>
          <label><input type="radio" name="divMode" value="drip" checked> DRIP（股利再投入）</label>
          <label><input type="radio" name="divMode" value="cash"> 現金發放</label>
        </div>
      </div>
      <div class="chart-container backtest-container">
        <canvas id="backtestChart"></canvas>
      </div>
    </div>

    <div class="two-column">
      <div class="input-section">
        <h3 class="chart-title">投資參數設定</h3>
        <div class="input-grid">
          <div class="input-group">
            <label>初期投入</label>
            <input type="number" id="initial" value="100000" min="0" />
          </div>
          <div class="input-group">
            <label>每月定投</label>
            <input type="number" id="monthly" value="10000" min="0" />
          </div>
          <div class="input-group">
            <label>目標金額</label>
            <input type="number" id="target" value="1000000" min="0" />
          </div>
        </div>
        
        <div class="inline-controls" style="gap:8px;">
          <div class="chart-title">投資曲線期間</div>
          <button class="chip horizon-years" data-years="3">3 年</button>
          <button class="chip horizon-years" data-years="5">5 年</button>
          <button class="chip horizon-years active" data-years="10">10 年</button>
          <button class="chip horizon-years" data-years="20">20 年</button>
        </div>

        <div class="summary-cards">
          <div class="summary-card invested">
            <div class="summary-label">累積投資金額</div>
            <div class="summary-value" id="totalInvested">1.2M</div>
          </div>
          <div class="summary-card total">
            <div class="summary-label">預估資產總額</div>
            <div class="summary-value highlight" id="totalValue">2.16M</div>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <h3 class="chart-title">投資曲線（<span id="currentPortfolioName">三基金組合</span>）</h3>
      <div class="chart-container">
        <canvas id="portfolioChart"></canvas>
      </div>
    </div>
  </div>

  <script>
    // ===== START: Real backtest data from CSV =====
    const csvData = `date,portfolio_monthly_return,portfolio_value,sp500_value
2015-09,0.0,10000,10000
2015-10,4.641281,10464,10852
2015-11,0.083464,10473,10891
2015-12,-1.358144,10331,10704
2016-01,-2.976404,10023,10171
2016-02,0.140376,10037,10162
2016-03,4.785094,10518,10846
2016-04,0.602034,10581,10887
2016-05,0.856407,10671,11073
2016-06,0.891452,10767,11112
2016-07,2.648846,11052,11517
2016-08,0.034062,11056,11531
2016-09,0.256037,11084,11532
2016-10,-1.649353,10901,11331
2016-11,1.075025,11018,11749
2016-12,1.293154,11161,11986
2017-01,1.39074,11316,12201
2017-02,2.276507,11574,12682
2017-03,0.272845,11605,12696
2017-04,1.061878,11728,12822
2017-05,1.064156,11853,13005
2017-06,0.522123,11915,13087
2017-07,1.437206,12086,13356
2017-08,0.479116,12144,13395
2017-09,1.215328,12292,13665
2017-10,1.283839,12450,13987
2017-11,1.567908,12645,14414
2017-12,0.987154,12770,14589
2018-01,2.688853,13113,15410
2018-02,-2.795057,12746,14851
2018-03,-0.7758,12648,14444
2018-04,-0.076668,12638,14518
2018-05,1.522184,12830,14871
2018-06,0.172254,12852,14958
2018-07,1.88818,13095,15513
2018-08,1.860865,13339,16007
2018-09,-0.119146,13323,16102
2018-10,-4.864418,12675,14990
2018-11,1.409369,12853,15267
2018-12,-4.403247,12287,13922
2019-01,5.465654,12959,15036
2019-02,1.9665,13214,15526
2019-03,1.558516,13420,15805
2019-04,2.261178,13723,16452
2019-05,-3.051125,13304,15401
2019-06,4.616228,13919,16474
2019-07,0.654825,14010,16722
2019-08,-0.146051,13989,16443
2019-09,0.923299,14118,16763
2019-10,1.511206,14332,17133
2019-11,2.037762,14624,17753
2019-12,1.68342,14870,18269
2020-01,0.484876,14942,18261
2020-02,-3.994062,14345,16817
2020-03,-9.06352,13045,14717
2020-04,8.484922,14152,16586
2020-05,3.389449,14632,17376
2020-06,1.787565,14893,17684
2020-07,3.876225,15471,18725
2020-08,3.685609,16041,20032
2020-09,-2.123937,15700,19282
2020-10,-1.476858,15468,18802
2020-11,7.669026,16654,20846
2020-12,2.714755,17107,21619
2021-01,-0.526705,17016,21399
2021-02,1.122931,17208,21994
2021-03,1.533247,17471,22993
2021-04,3.113774,18015,24209
2021-05,0.538466,18112,24368
2021-06,1.613016,18405,24915
2021-07,1.243874,18634,25523
2021-08,1.532632,18919,26283
2021-09,-3.017702,18348,25057
2021-10,3.701729,19027,26816
2021-11,-0.999935,18837,26600
2021-12,2.15294,19243,27831
2022-01,-4.196711,18435,26363
2022-02,-1.998482,18067,25585
2022-03,0.608468,18177,26547
2022-04,-6.881776,16926,24217
2022-05,0.315223,16979,24272
2022-06,-5.583615,16031,22270
2022-07,6.135305,17015,24321
2022-08,-3.414309,16434,23329
2022-09,-7.266102,15240,21172
2022-10,4.005627,15850,22893
2022-11,5.128399,16663,24166
2022-12,-3.863668,16019,22773
2023-01,5.609949,16918,24205
2023-02,-2.739795,16454,23597
2023-03,2.393797,16848,24472
2023-04,0.844219,16990,24863
2023-05,-0.600172,16888,24977
2023-06,3.382811,17460,26596
2023-07,2.060137,17819,27467
2023-08,-1.692967,17518,27020
2023-09,-4.098735,16800,25739
2023-10,-2.353219,16404,25180
2023-11,7.268847,17597,27480
2023-12,4.001084,18301,28734
2024-01,0.403923,18375,29192
2024-02,2.374645,18811,30715
2024-03,1.946608,19177,31720
2024-04,-3.548983,18497,30441
2024-05,2.383748,18938,31981
2024-06,2.545127,19420,33109
2024-07,1.966926,19802,33510
2024-08,1.772264,20152,34293
2024-09,1.455396,20446,35013
2024-10,-1.805473,20077,34701
2024-11,3.860892,20852,36770
2024-12,-2.984492,20229,35885
2025-01,2.063108,20647,36849
2025-02,-0.137753,20618,36381
2025-03,-3.401522,19917,34354
2025-04,-0.180554,19881,34056
2025-05,3.27418,20532,36196
2025-06,3.25979,21201,37944
2025-07,0.925679,21398,38818
2025-08,0.969379,21605,39188
`;
    let backtestData = [];
    // ===== END: Real backtest data from CSV =====


    // ===== Base data =====
    const portfolios = {
      "全天候策略": { allocations: { VTI: 30, TLT: 40, IEF: 15, GLD: 7.5, GSG: 7.5 }, CAGR: 0.078, volatility: 0.092, maxDrawdown: -0.28 },
      "三基金組合": { allocations: { VTI: 42, VXUS: 18, BND: 40 }, CAGR: 0.081, volatility: 0.105, maxDrawdown: -0.33 },
      "積極型股債組合": { allocations: { VT: 80, BNDW: 20 }, CAGR: 0.095, volatility: 0.132, maxDrawdown: -0.40 }
    };
    
    // Assumptions for dividend calculation
    const assetAssumptions = {
        VTI: { yield: 0.015 }, VXUS: { yield: 0.025 }, BND: { yield: 0.030 },
        TLT: { yield: 0.025 }, IEF: { yield: 0.025 }, GLD: { yield: 0.000 },
        GSG: { yield: 0.000 }, VT: { yield: 0.020 }, BNDW: { yield: 0.027 }
    };

    // Current portfolio for this page
    const selectedPortfolio = "三基金組合";
    let currentAllocations = { ...portfolios[selectedPortfolio].allocations };
    
    // State
    let years = 10;
    let backtestYears = 3;
    let divMode = 'drip';
    let initial = 100000;
    let monthly = 10000;
    let target = 1000000;

    let portfolioChart=null, backtestChart=null, pieChart = null;

    // Chart colors
    const pieColors = ['#208065', '#40A080', '#60C0A0', '#80E0C0', '#A0FFA0', '#806420', '#A08040', '#C0A060'];

    // ===== Chart.js global options =====
    Chart.defaults.elements.point.radius = 2;
    Chart.defaults.elements.point.hoverRadius = 3;
    Chart.defaults.animation = { duration: 200, easing: 'linear' };
    if(Chart.defaults.elements && Chart.defaults.elements.line){ Chart.defaults.elements.line.tension = 0; }

    // ===== Helpers =====
    function formatK(num){
      if(Math.abs(num) >= 1e6) return (num/1e6).toFixed(2).replace(/\.00$/,'') + 'M';
      if(Math.abs(num) >= 1e3) return (num/1e3).toFixed(1).replace(/\.0$/,'') + 'K';
      return num.toLocaleString();
    }
    function pct(n){ return (n*100).toFixed(1) + '%'; }
    function monthlyRate(annual){ return Math.pow(1+annual, 1/12) - 1; }

    // ===== NEW: Dividend Calculation Logic =====
    function getWeightedAvgYield(allocations) {
        let totalYield = 0;
        for (const [asset, percentage] of Object.entries(allocations)) {
            if (assetAssumptions[asset] && assetAssumptions[asset].yield) {
                totalYield += (percentage / 100) * assetAssumptions[asset].yield;
            }
        }
        return totalYield;
    }

    function calculateBacktestSeries(fullData, mode) {
        // 'drip' mode uses the pre-calculated total return value from CSV
        if (mode === 'drip') {
            return fullData.map(d => d.portfolio_value);
        }

        // 'cash' mode calculates estimated price return
        const annualYield = getWeightedAvgYield(currentAllocations);
        const monthlyYield = monthlyRate(annualYield);
        
        let cashValue = fullData[0]?.portfolio_value || 10000;
        const cashSeries = [cashValue];

        for (let i = 1; i < fullData.length; i++) {
            const totalMonthlyReturn = fullData[i].portfolio_monthly_return / 100;
            
            // Formula: (1 + PriceReturn) = (1 + TotalReturn) / (1 + DividendYield)
            const priceReturn = ((1 + totalMonthlyReturn) / (1 + monthlyYield)) - 1;
            
            cashValue = cashValue * (1 + priceReturn);
            cashSeries.push(cashValue);
        }
        return cashSeries;
    }


    // ===== Pie Chart Functions =====
    function initializePieChart() {
      const ctx = document.getElementById('pieChart').getContext('2d');
      if (pieChart) pieChart.destroy();
      pieChart = new Chart(ctx, {
        type: 'doughnut',
        data: { labels: [], datasets: [{ data: [], backgroundColor: pieColors, borderWidth: 2, borderColor: '#ffffff' }] },
        options: { responsive: true, maintainAspectRatio: true, plugins: { legend: { display: false } } }
      });
    }

    function updatePieChart(allocations) {
      if (!pieChart) return;
      const labels = [];
      const data = [];
      const legendContainer = document.getElementById('allocationLegend');
      legendContainer.innerHTML = '';
      let colorIndex = 0;
      for (const [asset, percentage] of Object.entries(allocations)) {
        if (percentage > 0) {
          labels.push(asset);
          data.push(percentage);
          const legendItem = document.createElement('div');
          legendItem.className = 'legend-item';
          legendItem.innerHTML = `<div class="legend-color" style="background-color: ${pieColors[colorIndex]}"></div><div class="legend-text">${asset}: ${percentage}%</div>`;
          legendContainer.appendChild(legendItem);
          colorIndex++;
        }
      }
      pieChart.data.labels = labels;
      pieChart.data.datasets[0].data = data;
      pieChart.update();
    }

    // ===== Calculations =====
    function buildProjectionSeries(years, initial, monthly, annualReturn){
      const data=[]; 
      let invested=initial, value=initial; 
      const m = monthly; 
      const r = monthlyRate(annualReturn);
      for(let y=1;y<=years;y++){
        for(let i=0;i<12;i++){ value = (value + m) * (1+r); invested += m; }
        data.push({ year:`${y}年`, invested:Math.round(invested), value:Math.round(value) });
      }
      return { data, invested, value };
    }

    // ===== Charts =====
    function updatePortfolioChart(data){
      const ctx = document.getElementById('portfolioChart').getContext('2d');
      if(portfolioChart) portfolioChart.destroy();
      portfolioChart = new Chart(ctx, {
        type:'line',
        data:{
          labels: data.map(d=>d.year),
          datasets:[
            { label:'累積投入金額', data:data.map(d=>d.invested), borderColor:'#2aa27f', backgroundColor:'rgba(21,90,71,.20)', fill:true, tension:.1 },
            { label:'累積總資產', data:data.map(d=>d.value), borderColor:'#5bc7a7', backgroundColor:'rgba(32,128,100,.25)', fill:true, tension:.1 }
          ]
        },
        options:{
          responsive:true, maintainAspectRatio:false,
          plugins:{ legend:{ labels:{ color:'#fff' } } },
          interaction:{ mode:'index', intersect:false },
          scales:{
            x:{ ticks:{ color:'#fff' }, grid:{ color:'rgba(255,255,255,.1)' } },
            y:{ ticks:{ color:'#fff', callback:v=>formatK(v) }, grid:{ color:'rgba(255,255,255,.1)' } }
          }
        }
      });
    }

    function updateBacktestChart(){
      const ctx = document.getElementById('backtestChart').getContext('2d');
      if(backtestChart) backtestChart.destroy();

      const months = backtestYears * 12;
      const slicedData = backtestData.slice(-months);
      
      const pSeries = calculateBacktestSeries(slicedData, divMode);
      const sSeries = slicedData.map(d => d.sp500_value);
      const xLabels = slicedData.map(d => d.date);
      
      const tickFontSize = window.innerWidth < 768 ? 10 : 12;

      backtestChart = new Chart(ctx, {
        type:'line',
        data:{
          labels:xLabels,
          datasets:[
            { label: `${selectedPortfolio} (${divMode.toUpperCase()})`, data:pSeries, borderColor:'#5bc7a7', fill:false },
            { label:'S&P 500', data:sSeries, borderColor:'#FFD700', fill:false }
          ]
        },
        options:{
          responsive:true, maintainAspectRatio:false,
          plugins:{ legend:{ labels:{ color:'#fff' } } },
          interaction:{ mode:'index', intersect:false },
          scales:{
            x:{
              ticks:{
                color:'#fff', autoSkip:true, maxTicksLimit: Math.min(12, backtestYears*4),
                font: { size: tickFontSize },
                callback: function(value){
                  const raw = xLabels[value];
                  if(typeof raw === 'string' && raw.includes('-')){
                    const [y,m] = raw.split('-');
                    if (parseInt(m) % 3 === 1) return `${y}/${m}`;
                    return null;
                  }
                  return raw;
                }
              },
              grid:{ color:'rgba(255,255,255,.08)' }
            },
            y:{ ticks:{ color:'#fff', callback:v=>formatK(v) }, grid:{ color:'rgba(255,255,255,.08)' } }
          }
        }
      });
    }

    // ===== Update flows =====
    function updatePerformanceFromWeights(){
      const portfolio = portfolios[selectedPortfolio];
      document.getElementById('annualReturn').textContent = pct(portfolio.CAGR);
      document.getElementById('volatility').textContent = pct(portfolio.volatility);
      document.getElementById('maxDrawdown').textContent = pct(portfolio.maxDrawdown);
    }

    function updateProjectionAndSummary(){
      const portfolio = portfolios[selectedPortfolio];
      const annualYield = getWeightedAvgYield(currentAllocations);
      const { data, invested, value } = buildProjectionSeries(years, initial, monthly, portfolio.CAGR + annualYield);

      document.getElementById('totalInvested').textContent = formatK(invested);
      document.getElementById('totalValue').textContent = formatK(value);
      const totalInvestedAmount = initial + monthly * 12 * years;
      const totalReturnPct = totalInvestedAmount > 0 ? ((value-totalInvestedAmount)/totalInvestedAmount)*100 : 0;
      document.getElementById('totalReturnPct').textContent = totalReturnPct.toFixed(1) + '%';

      document.getElementById('currentPortfolioName').textContent = selectedPortfolio;
      updatePortfolioChart(data);
    }
    
    function parseCSV(csvString) {
      const lines = csvString.trim().split('\n');
      const headers = lines.shift().split(',');
      return lines.map(line => {
        const values = line.split(',');
        const entry = {};
        headers.forEach((header, index) => {
          const key = header.trim();
          const value = values[index].trim();
          entry[key] = isNaN(Number(value)) ? value : Number(value);
        });
        return entry;
      });
    }

    // ===== Event wiring =====
    document.addEventListener('DOMContentLoaded', ()=>{
      backtestData = parseCSV(csvData);
      
      setTimeout(() => {
        initializePieChart();
        updatePieChart(currentAllocations);
        updatePerformanceFromWeights();
        updateProjectionAndSummary();
        updateBacktestChart();
      }, 100);

      document.querySelectorAll('.horizon-years').forEach(btn=>{
        btn.addEventListener('click', function(){
          document.querySelectorAll('.horizon-years').forEach(b=>b.classList.remove('active'));
          this.classList.add('active');
          years = parseInt(this.getAttribute('data-years'));
          updateProjectionAndSummary();
        });
      });

      document.querySelectorAll('.backtest-years').forEach(btn=>{
        btn.addEventListener('click', function(){
          document.querySelectorAll('.backtest-years').forEach(b=>b.classList.remove('active'));
          this.classList.add('active');
          backtestYears = parseInt(this.getAttribute('data-years'));
          updateBacktestChart();
        });
      });

      // DRIP vs CASH - This now triggers a chart update
      document.querySelectorAll('input[name="divMode"]').forEach(r=>{
        r.addEventListener('change', function(){
          divMode = this.value;
          updateBacktestChart(); // Recalculate and redraw the chart
        });
      });

      // Inputs
      const updateAll = () => { updateProjectionAndSummary(); updateBacktestChart(); };
      document.getElementById('initial').addEventListener('input', function(){ initial = Number(this.value)||0; updateProjectionAndSummary(); });
      document.getElementById('monthly').addEventListener('input', function(){ monthly = Number(this.value)||0; updateProjectionAndSummary(); });
      document.getElementById('target').addEventListener('input', function(){ target = Number(this.value)||0; updateProjectionAndSummary(); });
    });
  </script>
</body>
</html>