<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>積極型股債組合回測 - 墨鏡姐複利樹</title>
    <link href="https://cdn.jsdelivr.net/npm/vuetify@3.4.0/dist/vuetify.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@mdi/font@5.x/css/materialdesignicons.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <link rel="stylesheet" href="src/style.css">
</head>

<body>
    <div id="app">
        <v-app :theme="theme">
            <v-main>
                <v-container>
                    <v-row justify="center">
                        <v-col cols="12" md="11" lg="10">
                            <v-toolbar color="transparent">
                                <v-toolbar-title class="text-h5 font-weight-bold text-primary">墨鏡姐複利樹</v-toolbar-title>
                                <v-spacer></v-spacer>
                                <v-btn text href="goal.html">財務規劃</v-btn>
                                <v-btn text href="all_weather.html">全天候策略</v-btn>
                                <v-btn text href="classic3.html">三基金組合</v-btn>
                                <v-btn text href="aggressive.html" variant="tonal" color="primary">積極型股債組合</v-btn>
                            </v-toolbar>

                            <v-card class="mt-4" flat color="transparent">
                               <v-card-text>
                                <v-col cols="12" md="5">
                                  <h1>積極型股債組合</h1>
                                </v-col>
                                 <v-row>
                                  
                                    <!-- Performance & Allocation -->
                                    <v-col cols="12" md="5">
                                        <v-row>
                                            <v-col cols="12">
                                                <v-card>
                                                    <v-card-title>績效表現</v-card-title>
                                                    <v-row dense class="pa-2">
                                                        <v-col cols="12" sm="6"><v-card color="surface-variant" flat><v-card-text><div class="text-caption">年化報酬率 (估)</div><div class="text-h5 font-weight-bold text-primary">{{ pct(portfolio.data.CAGR) }}</div></v-card-text></v-card></v-col>
                                                        <v-col cols="12" sm="6"><v-card color="surface-variant" flat><v-card-text><div class="text-caption">年化波動率</div><div class="text-h5 font-weight-bold">{{ pct(portfolio.data.volatility) }}</div></v-card-text></v-card></v-col>
                                                        <v-col cols="12"><v-card color="surface-variant" flat><v-card-text><div class="text-caption">最大回撤</div><div class="text-h5 font-weight-bold text-error">{{ pct(portfolio.data.maxDrawdown) }}</div></v-card-text></v-card></v-col>
                                                    </v-row>
                                                </v-card>
                                            </v-col>
                                            <v-col cols="12">
                                                <v-card>
                                                    <v-card-title>組成標的與比例</v-card-title>
                                                    <v-card-text>
                                                        <div class="pie-chart-container"><canvas id="pie-chart"></canvas></div>
                                                        <v-row dense class="mt-4">
                                                            <v-col v-for="(percent, asset) in portfolio.data.allocations" :key="asset" cols="12" sm="6">
                                                                <div class="legend-item">
                                                                    <div class="legend-color" :style="{ backgroundColor: pieColors[Object.keys(portfolio.data.allocations).indexOf(asset)] }"></div>
                                                                    <div>{{ asset }}: {{ percent }}%</div>
                                                                </div>
                                                            </v-col>
                                                        </v-row>
                                                    </v-card-text>
                                                </v-card>
                                            </v-col>
                                        </v-row>
                                    </v-col>
                                    <!-- Backtest & Projection -->
                                    <v-col cols="12" md="7">
                                        <v-card class="h-100">
                                            <v-card-title>歷史回測 (與 S&P 500 比較)</v-card-title>
                                            <v-card-text>
                                                <v-chip-group v-model="backtestYears" mandatory color="primary">
                                                    <v-chip :value="3">近 3 年</v-chip>
                                                    <v-chip :value="5">近 5 年</v-chip>
                                                    <v-chip :value="10">近 10 年</v-chip>
                                                </v-chip-group>
                                                <div style="height: 380px;"><canvas id="backtest-chart"></canvas></div>
                                            </v-card-text>
                                        </v-card>
                                    </v-col>
                                    <v-col cols="12">
                                        <v-card>
                                            <v-card-title>投資成長曲線</v-card-title>
                                            <v-card-text>
                                                <v-row align="center" dense>
                                                    <v-col cols="12" sm="4" md="2"><v-text-field v-model.number="form.initial" label="初期投入" type="number" variant="outlined" dense hide-details></v-text-field></v-col>
                                                    <v-col cols="12" sm="4" md="2"><v-text-field v-model.number="form.monthly" label="每月定投" type="number" variant="outlined" dense hide-details></v-text-field></v-col>
                                                    <v-col cols="12" sm="4" md="8">
                                                        <v-chip-group v-model="projectionYears" mandatory color="primary">
                                                            <v-chip :value="3">3 年</v-chip> <v-chip :value="5">5 年</v-chip> <v-chip :value="10">10 年</v-chip> <v-chip :value="20">20 年</v-chip>
                                                        </v-chip-group>
                                                    </v-col>
                                                </v-row>
                                                <v-row class="mt-4" dense>
                                                    <v-col cols="12" sm="6"><v-card color="secondary" flat><v-card-text><div class="text-caption">累積投資金額</div><div class="text-h5 font-weight-bold">{{ formatK(projectionResult.invested) }}</div></v-card-text></v-card></v-col>
                                                    <v-col cols="12" sm="6"><v-card color="primary" flat><v-card-text><div class="text-caption">預估資產總額</div><div class="text-h5 font-weight-bold">{{ formatK(projectionResult.value) }}</div></v-card-text></v-card></v-col>
                                                </v-row>
                                                <div style="height: 300px; margin-top: 16px;"><canvas id="projection-chart"></canvas></div>
                                            </v-card-text>
                                        </v-card>
                                    </v-col>
                                 </v-row>
                               </v-card-text>
                            </v-card>
                        </v-col>
                    </v-row>
                </v-container>
            </v-main>
        </v-app>
    </div>

    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vuetify@3.4.0/dist/vuetify.min.js"></script>
    <script>
        const { createApp, ref, watch, onMounted, nextTick } = Vue;
        const { createVuetify } = Vuetify;

        const customDarkTheme = { dark: true, colors: { background: '#0D0D0D', surface: 'rgba(0, 0, 0, .1)', 'surface-variant': 'rgba(0, 0, 0, .2)', primary: '#208065', secondary: '#806420', error: '#CF6679' } };
        const vuetify = createVuetify({ theme: { defaultTheme: 'dark', themes: { dark: customDarkTheme } } });

        createApp({
            setup() {
                const theme = ref('dark');
                const portfolio = { name: "積極型股債組合", data: { allocations: { VT: 80, BNDW: 20 }, CAGR: 0.095, volatility: 0.132, maxDrawdown: -0.40 } };
                const csvData = `date,portfolio_monthly_return,portfolio_value,sp500_value\n2018-09,0.0,10000,10000\n2018-10,-6.317512,9368,9309\n2018-11,1.4886,9508,9481\n2018-12,-5.492364,8986,8646\n2019-01,6.605953,9579,9338\n2019-02,2.266411,9796,9642\n2019-03,1.232524,9917,9815\n2019-04,2.773613,10192,10217\n2019-05,-4.456666,9738,9565\n2019-06,5.380047,10262,10231\n2019-07,0.142573,10276,10385\n2019-08,-1.195523,10153,10212\n2019-09,1.700934,10326,10410\n2019-10,2.21261,10555,10640\n2019-11,2.009083,10767,11025\n2019-12,2.722979,11060,11346\n2020-01,-0.861698,10965,11341\n2020-02,-5.545945,10356,10444\n2020-03,-12.154881,9098,9140\n2020-04,8.65426,9885,10300\n2020-05,4.263358,10306,10791\n2020-06,2.584075,10573,10982\n2020-07,4.464509,11045,11629\n2020-08,4.636744,11557,12441\n2020-09,-2.289037,11292,11975\n2020-10,-1.672429,11103,11676\n2020-11,10.068498,12221,12946\n2020-12,3.974669,12707,13426\n2021-01,-0.332697,12665,13289\n2021-02,1.769138,12889,13659\n2021-03,2.19621,13172,14279\n2021-04,3.354664,13614,15035\n2021-05,1.284875,13789,15133\n2021-06,1.057743,13935,15473\n2021-07,0.741114,14038,15850\n2021-08,1.740911,14282,16322\n2021-09,-3.507694,13781,15561\n2021-10,4.045578,14339,16653\n2-11,-1.954148,14059,16519\n2021-12,2.938678,14472,17283\n2022-01,-4.013946,13891,16372\n2022-02,-2.45273,13550,15889\n2022-03,1.013406,13688,16486\n2022-04,-7.182964,12704,15039\n2022-05,0.412172,12757,15073\n2022-06,-6.814404,11887,13830\n2022-07,6.148232,12618,15104\n2022-08,-3.897756,12126,14488\n2022-09,-8.340167,11115,13148\n2022-10,4.974259,11668,14217\n2022-11,7.277363,12517,15008\n2022-12,-3.964138,12021,14143\n2023-01,6.680477,12824,15032\n2023-02,-3.007823,12438,14654\n2023-03,2.499771,12749,15197\n2023-04,1.183074,12900,15440\n2023-05,-1.102514,12758,15512\n2023-06,4.010855,13270,16517\n2023-07,2.901932,13655,17057\n2023-08,-2.350871,13334,16780\n2023-09,-4.184046,12776,15984\n2023-10,-2.552329,12450,15637\n2023-11,7.945186,13439,17066\n2023-12,3.808067,13951,17845\n2024-01,-0.09568,13937,18129\n2024-02,3.36637,14406,19075\n2024-03,2.382338,14750,19699\n2024-04,-3.295477,14263,18904\n2024-05,2.566814,14630,19861\n2024-06,2.198283,14951,20561\n2024-07,1.972183,15246,20810\n2024-08,2.025305,15555,21297\n2024-09,1.68196,15816,21744\n2024-10,-2.132408,15479,21550\n2024-11,3.533217,16026,22835\n2024-12,-3.443172,15474,22286\n2025-01,2.520929,15864,22884\n2025-02,-0.061578,15855,22594\n2025-03,-3.226892,15343,21335\n2025-04,0.59961,15435,21150\n2025-05,4.506472,16131,22479\n2025-06,3.478981,16692,23564\n2025-07,0.796911,16825,24107\n2025-08,1.720603,17114,24337`;
                const backtestData = ref([]);
                const backtestYears = ref(3);
                const projectionYears = ref(10);
                const form = ref({ initial: 100000, monthly: 10000 });
                const projectionResult = ref({ invested: 0, value: 0 });
                const pieColors = ['#208065', '#40A080', '#60C0A0', '#80E0C0', '#A0FFA0', '#806420'];
                const charts = {};

                const parseCSV = (csv) => { const lines = csv.trim().split('\n'); const headers = lines.shift().split(','); return lines.map(line => { const values = line.split(','); const entry = {}; headers.forEach((h, i) => { entry[h.trim()] = isNaN(Number(values[i])) ? values[i] : Number(values[i]); }); return entry; }); };
                const createOrUpdateChart = (id, config) => { if (charts[id]) { charts[id].data = config.data; charts[id].options = config.options; charts[id].update(); } else { const ctx = document.getElementById(id)?.getContext('2d'); if (ctx) charts[id] = new Chart(ctx, config); } };
                const drawPieChart = () => createOrUpdateChart('pie-chart', { type: 'doughnut', data: { labels: Object.keys(portfolio.data.allocations), datasets: [{ data: Object.values(portfolio.data.allocations), backgroundColor: pieColors, borderWidth: 2, borderColor: '#0D0D0D' }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } } });
                const drawBacktestChart = () => { const slicedData = backtestData.value.slice(-(backtestYears.value * 12)); createOrUpdateChart('backtest-chart', { type: 'line', data: { labels: slicedData.map(d => d.date), datasets: [{ label: portfolio.name, data: slicedData.map(d => d.portfolio_value), borderColor: '#208065', tension: 0.1, pointRadius: 0 }, { label: 'S&P 500', data: slicedData.map(d => d.sp500_value), borderColor: '#806420', tension: 0.1, pointRadius: 0 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { x: { ticks: { color: '#FFF' } }, y: { ticks: { color: '#FFF', callback: v => formatK(v) } } }, plugins: { legend: { labels: { color: '#FFF' } } } } }); };
                const drawProjectionChart = () => { const { data, invested, value } = buildProjectionSeries(); projectionResult.value = { invested, value }; createOrUpdateChart('projection-chart', { type: 'line', data: { labels: data.map(d => d.year), datasets: [{ label: '累積投入', data: data.map(d => d.invested), borderColor: '#806420', backgroundColor: 'rgba(128, 100, 32, 0.2)', fill: true, tension: 0.1 }, { label: '資產總額', data: data.map(d => d.value), borderColor: '#208065', backgroundColor: 'rgba(32, 128, 101, 0.2)', fill: true, tension: 0.1 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { x: { ticks: { color: '#FFF' } }, y: { ticks: { color: '#FFF', callback: v => formatK(v) } } }, plugins: { legend: { labels: { color: '#FFF' } } } } }); };
                const buildProjectionSeries = () => { const { initial, monthly } = form.value; const data = []; let invested = initial, value = initial; const r = Math.pow(1 + portfolio.data.CAGR, 1 / 12) - 1; for (let y = 1; y <= projectionYears.value; y++) { for (let i = 0; i < 12; i++) { value = (value + monthly) * (1 + r); invested += monthly; } data.push({ year: `${y}年`, invested: Math.round(invested), value: Math.round(value) }); } return { data, invested, value }; };
                const formatK = (num) => { if (Math.abs(num) >= 1e6) return (num / 1e6).toFixed(2) + 'M'; if (Math.abs(num) >= 1e3) return (num / 1e3).toFixed(1) + 'K'; return num.toLocaleString(); };
                const pct = (n) => (n * 100).toFixed(1) + '%';
                
                watch(backtestYears, drawBacktestChart);
                watch([form, projectionYears], drawProjectionChart, { deep: true });
                onMounted(() => { backtestData.value = parseCSV(csvData); nextTick(() => { drawPieChart(); drawBacktestChart(); drawProjectionChart(); }); });

                return { theme, portfolio, backtestYears, projectionYears, form, projectionResult, pieColors, formatK, pct };
            }
        }).use(vuetify).mount('#app');
    </script>
</body>
</html>
