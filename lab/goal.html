<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è²¡å‹™è¦åŠƒ - å¢¨é¡å§è¤‡åˆ©æ¨¹</title>
    <link href="https://cdn.jsdelivr.net/npm/vuetify@3.4.0/dist/vuetify.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@mdi/font@5.x/css/materialdesignicons.min.css" rel="stylesheet">
    <link rel="stylesheet" href="src/style.css">
</head>

<body>
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <h3>è¼‰å…¥ä¸­...</h3>
            <p>æ­£åœ¨æº–å‚™æ‚¨çš„è²¡å‹™è¦åŠƒå·¥å…·</p>
        </div>
    </div>

    <div id="app" style="opacity: 0; transition: opacity 0.5s ease-in;">
        <v-app :theme="theme">
            <div id="chartTooltip" class="chart-tooltip"></div>
            <v-main>
                <v-container>
                    <v-row justify="center">
                        <v-col cols="12" md="11" lg="10">
                            <v-toolbar color="transparent">
                                <v-toolbar-title class="text-h5 font-weight-bold text-primary">å¢¨é¡å§è¤‡åˆ©æ¨¹</v-toolbar-title>
                                <v-spacer></v-spacer>
                                <v-btn text href="goal.html" variant="tonal" color="primary">è²¡å‹™è¦åŠƒ</v-btn>
                                <v-btn text href="all_weather.html">å…¨å¤©å€™ç­–ç•¥</v-btn>
                                <v-btn text href="classic3.html">ä¸‰åŸºé‡‘çµ„åˆ</v-btn>
                                <v-btn text href="aggressive.html">ç©æ¥µå‹è‚¡å‚µçµ„åˆ</v-btn>
                                <v-btn text href="core4.html">æ ¸å¿ƒå››åŸºé‡‘</v-btn>
                                <v-btn text href="voo.html">å·´è²ç‰¹æ¨è–¦</v-btn>
                            </v-toolbar>

                            <v-card class="mt-4" :color="theme === 'dark' ? 'surface' : 'grey-lighten-5'" flat>
                                <v-card-title class="text-h5">{{ pageTitle }}</v-card-title>
                                <v-card-text>
                                    <v-row>
                                        <v-col cols="12" md="4">
                                            <v-card>
                                                <v-card-title>åŸºæœ¬è¨­å®š</v-card-title>
                                                <v-card-text>
                                                    <v-select v-model="form.goalType" :items="goalOptions" item-title="text" item-value="value" label="é¸æ“‡è²¡å‹™ç›®æ¨™" variant="outlined" dense></v-select>
                                                    <v-text-field v-model.number="form.currentAge" label="ç›®å‰å¹´é½¡" type="number" suffix="æ­²" variant="outlined" dense class="mt-4"></v-text-field>
                                                    <v-text-field v-model.number="form.targetAge" :label="targetAgeLabel" type="number" suffix="æ­²" variant="outlined" dense class="mt-4"></v-text-field>
                                                    <v-text-field v-model.number="form.targetValue" :label="targetAmountLabel" type="number" suffix="è¬å…ƒ" variant="outlined" dense class="mt-4"></v-text-field>
                                                    <v-text-field v-model.number="form.currentAssets" label="ç•¶å‰ç¸½è³‡ç”¢" type="number" suffix="è¬å…ƒ" variant="outlined" dense class="mt-4"></v-text-field>
                                                    <v-text-field v-model.number="form.monthlyInvestment" label="æ¯æœˆæŠ•è³‡é‡‘é¡" type="number" suffix="è¬å…ƒ" variant="outlined" dense class="mt-4"></v-text-field>
                                                    <v-select v-model="form.strategyReturn" :items="strategyOptions" item-title="text" item-value="value" label="é¸æ“‡æŠ•è³‡ç­–ç•¥" variant="outlined" dense class="mt-4"></v-select>
                                                    <v-btn block color="primary" size="large" @click="calculate" class="mt-4">{{ calculateButtonText }}</v-btn>
                                                </v-card-text>
                                            </v-card>

                                            <v-card class="mt-4" v-if="savedGoals.length > 0">
                                                <v-card-title class="d-flex align-center">
                                                    <v-icon class="mr-2">mdi-bookmark-outline</v-icon>
                                                    å·²å­˜ç›®æ¨™
                                                </v-card-title>
                                                <v-card-text>
                                                    <div v-for="(goal, index) in savedGoals" :key="index" class="mb-2">
                                                        <v-card 
                                                            class="saved-goal-card pa-3" 
                                                            variant="outlined"
                                                            @click="loadSavedGoal(goal)"
                                                        >
                                                            <div class="d-flex justify-space-between align-center">
                                                                <div>
                                                                    <div class="font-weight-bold">{{ goalTypes[goal.goalType].title }}</div>
                                                                    <div class="text-caption text-medium-emphasis">
                                                                        {{ goal.currentAge }}æ­² â†’ {{ goal.targetAge }}æ­² | ç›®æ¨™: {{ goal.targetValue }}è¬å…ƒ
                                                                    </div>
                                                                </div>
                                                                <v-btn 
                                                                    icon="mdi-delete" 
                                                                    size="small" 
                                                                    variant="text" 
                                                                    color="error"
                                                                    @click.stop="deleteSavedGoal(index)"
                                                                ></v-btn>
                                                            </div>
                                                            <div class="mt-3">
                                                                <div class="d-flex justify-space-between text-caption text-medium-emphasis mb-1">
                                                                    <span>ç•¶å‰: {{ (goal.currentAssets).toLocaleString() }}è¬</span>
                                                                    <span>ç›®æ¨™: {{ Math.round(getCalculatedTargetAmount(goal) / 10000).toLocaleString() }}è¬</span>
                                                                </div>
                                                                <v-progress-linear
                                                                    :model-value="calculateGoalProgress(goal)"
                                                                    color="success"
                                                                    height="6"
                                                                    rounded
                                                                ></v-progress-linear>
                                                            </div>
                                                        </v-card>
                                                    </div>
                                                </v-card-text>
                                            </v-card>
                                        </v-col>
                                        
                                        <v-col cols="12" md="8">
                                            <v-scroll-y-transition>
                                                <div v-if="results.show">
                                                    <div class="d-flex justify-space-between align-center mb-4">
                                                        <h2 class="text-h6">{{ resultsTitle }}</h2>
                                                        <v-btn 
                                                            color="success" 
                                                            variant="tonal" 
                                                            prepend-icon="mdi-content-save"
                                                            @click="saveGoal"
                                                            :disabled="!isLoggedIn"
                                                        >
                                                            {{ isLoggedIn ? 'å„²å­˜ç›®æ¨™' : 'ç™»å…¥å¾Œå¯å„²å­˜' }}
                                                        </v-btn>
                                                    </div>
                                                    <v-card variant="flat" color="white">
                                                        <v-card-text class="pa-6">
                                                            <div id="customChart" v-html="chartHTML"></div>
                                                        </v-card-text>
                                                    </v-card>
                                                    <v-alert :type="results.isGoalAchieved ? 'success' : 'warning'" variant="tonal" class="mt-6" border="start" prominent>
                                                        <h3 class="mb-2">{{ results.isGoalAchieved ? 'ç›®å‰ç­–ç•¥å¯é”æˆç›®æ¨™ï¼' : 'ç›®å‰ç­–ç•¥ç„¡æ³•é”æˆç›®æ¨™' }}</h3>
                                                        <div>é è¨ˆé”æˆæ™‚è³‡ç”¢ï¼š<strong>{{ Math.round(results.finalAsset / 10000) }} è¬å…ƒ</strong></div>
                                                        <div v-if="!results.isGoalAchieved">
                                                            <div>ç›®æ¨™é‡‘é¡ï¼š<strong>{{ Math.round(results.goalAmount / 10000) }} è¬å…ƒ</strong></div>
                                                            <div>è³‡é‡‘ç¼ºå£ï¼š<strong>{{ Math.round((results.goalAmount - results.finalAsset) / 10000) }} è¬å…ƒ</strong></div>
                                                            <v-divider class="my-3"></v-divider>
                                                            <strong>æ ¹æ“šè¨ˆç®—çµæœï¼Œå¦‚æƒ³åœ¨ç›®æ¨™æœŸå…§é”æˆç›®æ¨™ï¼Œå¯é¸æ“‡ï¼š</strong>
                                    
                                                            <v-row class="mt-4" dense>
                                                                <v-col cols="12" sm="6"><v-card color="secondary" flat><v-card-text><div class="text-caption">å°‡å¹´åŒ–å ±é…¬ç‡æé«˜è‡³</div><div class="text-h5 font-weight-bold">{{ results.requiredReturn.toFixed(1) }}%</div></v-card-text></v-card></v-col>
                                                                <v-col cols="12" sm="6"><v-card color="primary" flat><v-card-text><div class="text-caption">å°‡æ¯æœˆæŠ•è³‡é‡‘é¡æé«˜è‡³</div><div class="text-h5 font-weight-bold">{{ results.requiredInvestment.toFixed(1) }} è¬å…ƒ</div></v-card-text></v-card></v-col>
                                                            </v-row>
                                                        </div>
                                                    </v-alert>
                                                </div>
                                                <div v-else class="d-flex align-center justify-center" style="height: 100%;">
                                                    <div class="text-center text-grey">
                                                        <v-icon size="64">mdi-chart-line</v-icon>
                                                        <p class="mt-4">è«‹è¼¸å…¥æ‚¨çš„è²¡å‹™ç›®æ¨™ä¸¦é»æ“Šè¨ˆç®—</p>
                                                    </div>
                                                </div>
                                            </v-scroll-y-transition>
                                        </v-col>
                                    </v-row>
                                    
                                    <v-scroll-y-transition>
                                        <div v-if="results.show" class="mt-8">
                                            <h3 class="text-h6 text-center mb-4">ğŸ’¡ ç­–ç•¥æŠ•è³‡çµ„åˆå»ºè­°</h3>
                                            <v-row>
                                                <v-col v-for="rec in recommendationResults" :key="rec.name" cols="12" md="4">
                                                    <v-card class="strategy-card h-100" :class="{ 'recommended': rec.isBest }" variant="outlined" @click="selectStrategy(rec.name)">
                                                        <v-card-item>
                                                            <div class="d-flex justify-space-between align-center mb-2">
                                                                <div class="text-h6">{{ rec.name }}</div>
                                                                <v-chip size="small" color="primary" variant="flat">{{ (rec.expectedReturn * 100).toFixed(1) }}%</v-chip>
                                                            </div>
                                                            <div v-if="rec.isMetByInitial" class="font-weight-bold mb-3 text-success">
                                                                âœ”ï¸ ç¾æœ‰æœˆæŠ•é‡‘é¡è¶³ä»¥é”æˆç›®æ¨™
                                                            </div>
                                                            <div v-else class="font-weight-bold mb-3 text-success">
                                                                å¯æ­é…æœˆæŠ•ï¼šUSD$ {{ rec.requiredMonthly.toLocaleString() }}
                                                            </div>
                                                            <div class="text-caption text-medium-emphasis mb-3">{{ rec.reason }}</div>
                                                        </v-card-item>
                                                    </v-card>
                                                </v-col>
                                            </v-row>
                                        </div>
                                    </v-scroll-y-transition>
                                </v-card-text>
                            </v-card>
                        </v-col>
                        
                    </v-row>
                </v-container>
            </v-main>

            <v-snackbar v-model="snackbar.show" :color="snackbar.color" :timeout="3000" top>
                {{ snackbar.message }}
                <template v-slot:actions>
                    <v-btn variant="text" @click="snackbar.show = false">é—œé–‰</v-btn>
                </template>
            </v-snackbar>
        </v-app>
    </div>

    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vuetify@3.4.0/dist/vuetify.min.js"></script>

    <script>
        // Loading management
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                const loadingOverlay = document.getElementById('loadingOverlay');
                const app = document.getElementById('app');
                
                loadingOverlay.style.opacity = '0';
                app.style.opacity = '1';
                
                setTimeout(() => {
                    loadingOverlay.style.display = 'none';
                }, 500);
            }, 1500);
        });

        const { createApp, ref, computed, watch, nextTick } = Vue;
        const { createVuetify } = Vuetify;

        const customDarkTheme = {
            dark: true,
            colors: { background: '#0D0D0D', surface: '#1A1A1A', 'surface-variant': 'rgba(32, 128, 100, .2)', primary: '#208065', 'primary-darken-1': '#40A080', secondary: '#806420', error: '#CF6679', success: '#4CAF50' },
        };
        const vuetify = createVuetify({ theme: { defaultTheme: 'dark', themes: { dark: customDarkTheme } } });

        const app = createApp({
            setup() {
                const theme = ref('dark');
                
                // --- Static Data ---
                const inflationRate = 0.03;
                const goalTypes = { 
                    retirement: { title: "é€€ä¼‘è¦åŠƒ", CurrentAge:"ç›®å‰å¹´é½¡", ageLabel: "é è¨ˆé€€ä¼‘å¹´é½¡", amountLabel: "æ¯æœˆæœŸæœ›é€€ä¼‘è¢«å‹•æ”¶å…¥(è¬å…ƒ)", withdrawRate: 0.04 }, 
                    house: { title: "è³¼å±‹è¨ˆç•«", CurrentAge:"ç›®å‰å¹´é½¡", ageLabel: "é è¨ˆè³¼å±‹å¹´é½¡", amountLabel: "ç›®æ¨™æˆ¿å±‹ç¸½åƒ¹(è¬å…ƒ)", withdrawRate: 1.0 }, 
                    education: { title: "æ•™è‚²åŸºé‡‘", CurrentAge:"å­©å­ç›®å‰å¹´é½¡", ageLabel: "å­©å­é è¨ˆå…¥å­¸å¹´é½¡", amountLabel: "é ä¼°æ•™è‚²ç¸½è²»ç”¨(è¬å…ƒ)", withdrawRate: 1.0 }, 
                    emergency: { title: "ç·Šæ€¥é å‚™é‡‘", CurrentAge:"ç›®å‰å¹´é½¡", ageLabel: "é è¨ˆå®Œæˆå¹´é½¡", amountLabel: "ç·Šæ€¥é å‚™é‡‘ç›®æ¨™(è¬å…ƒ)", withdrawRate: 1.0 }, 
                    custom: { title: "è‡ªå®šç¾©ç›®æ¨™", CurrentAge:"ç›®å‰å¹´é½¡", ageLabel: "é è¨ˆé”æˆå¹´é½¡", amountLabel: "ç›®æ¨™é‡‘é¡(è¬å…ƒ)", withdrawRate: 1.0 } 
                };
                
                const strategies = { 
                    'å…¨å¤©å€™ç­–ç•¥': { expectedReturn: 0.05, volatility: 0.67, allocation: { 'VTI': 30, 'TLT': 40, 'IEF': 15, 'GLD': 7.5, 'DBC': 7.5 } }, 
                    'ä¸‰åŸºé‡‘çµ„åˆ': { expectedReturn: 0.08, volatility: 0.76, allocation: { 'VTI (ç¾åœ‹è‚¡å¸‚)': 60, 'VTIAX (åœ‹éš›è‚¡å¸‚)': 20, 'BND (å‚µåˆ¸)': 20 } }, 
                    'ç©æ¥µå‹è‚¡å‚µçµ„åˆ': { expectedReturn: 0.099, volatility: 0.6, allocation: { 'VTI (ç¾åœ‹è‚¡å¸‚)': 70, 'VTIAX (åœ‹éš›è‚¡å¸‚)': 10, 'BND (å‚µåˆ¸)': 20 } },
                    'æ ¸å¿ƒå››åŸºé‡‘': { expectedReturn: 0.1, volatility: 0.71, allocation: { 'VTI (ç¾åœ‹è‚¡å¸‚)': 50, 'VXUS': 20, 'VNQ':10,'BND (å‚µåˆ¸)': 20 } },
                    'å·´è²ç‰¹æ¨è–¦': { expectedReturn: 0.128, volatility: 0.82, allocation: { 'VOO': 100} } 
                };
                
                const strategyReasons = { 
                    'å…¨å¤©å€™ç­–ç•¥': 'æ­¤ç­–ç•¥æä¾›è‰¯å¥½çš„é¢¨éšªåˆ†æ•£ï¼Œé©åˆè¿½æ±‚ç©©å®šå ±é…¬çš„æŠ•è³‡è€…', 
                    'ä¸‰åŸºé‡‘çµ„åˆ': 'ç°¡å–®è€Œæœ‰æ•ˆçš„é…ç½®ï¼Œé©åˆé•·æœŸæŠ•è³‡ä¸”å¸Œæœ›é™ä½ç®¡ç†è¤‡é›œåº¦çš„æŠ•è³‡è€…', 
                    'ç©æ¥µå‹è‚¡å‚µçµ„åˆ': 'è¼ƒé«˜çš„è‚¡ç¥¨é…ç½®èƒ½å¸¶ä¾†æ›´å¥½çš„é•·æœŸå ±é…¬ï¼Œé©åˆå¹´è¼•ä¸”é¢¨éšªæ‰¿å—åº¦é«˜çš„æŠ•è³‡è€…',
                    'æ ¸å¿ƒå››åŸºé‡‘': 'ã€Œä¸‰åŸºé‡‘çµ„åˆã€çš„é€²éšé¸é …ï¼Œå¢åŠ æˆ¿åœ°ç”¢ä»¥å°æŠ—é€šè†¨ã€‚', 
                    'å·´è²ç‰¹æ¨è–¦': 'å®Œå…¨ç›¸ä¿¡ä¸¦æŠ¼æ³¨æ–¼ç¾åœ‹æœ€å…·ä»£è¡¨æ€§çš„ 500 å®¶é ‚ç´šä¼æ¥­çš„é•·æœŸå¢é•·ã€‚'  
                };

                // --- Reactive State ---
                const form = ref({ goalType: 'retirement', currentAge: 25, targetAge: 65, targetValue: 8, currentAssets: 100, monthlyInvestment: 2, strategyReturn: 0.075 });
                const results = ref({ show: false });
                const chartHTML = ref('');
                const recommendationResults = ref([]);
                const savedGoals = ref([]);
                const isLoggedIn = ref(true); 
                const snackbar = ref({ show: false, message: '', color: 'success' });

                // Load saved goals from localStorage on init
                const loadSavedGoals = () => {
                    try {
                        const stored = localStorage.getItem('financialGoals');
                        if (stored) savedGoals.value = JSON.parse(stored);
                    } catch (error) { console.error('Error loading saved goals:', error); }
                };

                // Save goals to localStorage
                const saveGoalsToStorage = () => {
                    try {
                        localStorage.setItem('financialGoals', JSON.stringify(savedGoals.value));
                    } catch (error) { console.error('Error saving goals:', error); }
                };

                loadSavedGoals();

                // --- Computed Properties ---
                const currentGoalConfig = computed(() => goalTypes[form.value.goalType]);
                const pageTitle = computed(() => `${currentGoalConfig.value.title}å·¥å…·`);
                const targetCurrentAge = computed(() => currentGoalConfig.value.CurrentAge); 
                const targetAgeLabel = computed(() => currentGoalConfig.value.ageLabel);
                const targetAmountLabel = computed(() => currentGoalConfig.value.amountLabel);
                const resultsTitle = computed(() => `${currentGoalConfig.value.title}åˆ†æçµæœ`);
                const calculateButtonText = computed(() => `è¨ˆç®—${currentGoalConfig.value.title}`);
                const goalOptions = Object.keys(goalTypes).map(key => ({ text: goalTypes[key].title, value: key }));
                const strategyOptions = [ 
                    { text: 'æ¥µä¿å®ˆå‹ - å…¨å¤©å€™ç­–ç•¥ (5%)', value: 0.05 }, { text: 'ç©©å¥å‹ - ä¸‰åŸºé‡‘çµ„åˆ (8%)', value: 0.08 }, { text: 'ç©æ¥µå‹ - ç©æ¥µå‹è‚¡å‚µ (9.9%)', value: 0.099 }, { text: 'å¢é•·å‹ - æ ¸å¿ƒå››åŸºé‡‘ (8.6%)', value: 0.086 }, { text: 'é«˜é¢¨éšªå‹ - å·´è²ç‰¹æ¨è–¦ (12.8%)', value: 0.128 } 
                ];
                
                watch(() => form.value.goalType, () => { results.value.show = false; });

                // --- Tooltip Functions ---
                const showTooltip = (event, content) => {
                    const tooltipEl = document.getElementById('chartTooltip');
                    if (tooltipEl) {
                        tooltipEl.innerHTML = content;
                        tooltipEl.classList.add('visible');
                        moveTooltip(event);
                    }
                };
                const moveTooltip = (event) => {
                    const tooltipEl = document.getElementById('chartTooltip');
                    if (tooltipEl) {
                        const tooltipRect = tooltipEl.getBoundingClientRect();
                        tooltipEl.style.left = `${event.pageX - (tooltipRect.width / 2)}px`;
                        tooltipEl.style.top = `${event.pageY - tooltipRect.height - 15}px`;
                    }
                };
                const hideTooltip = () => {
                    const tooltipEl = document.getElementById('chartTooltip');
                    if (tooltipEl) tooltipEl.classList.remove('visible');
                };

                // --- Save/Load Goals Functions ---
                const saveGoal = () => {
                    if (!isLoggedIn.value) {
                        snackbar.value = { show: true, message: 'è«‹å…ˆç™»å…¥æ‰èƒ½å„²å­˜ç›®æ¨™', color: 'warning' };
                        return;
                    }
                    const goalData = { ...form.value, savedAt: new Date().toISOString() };
                    const existingIndex = savedGoals.value.findIndex(goal => goal.goalType === goalData.goalType);
                    
                    if (existingIndex !== -1) {
                        savedGoals.value[existingIndex] = goalData;
                        snackbar.value = { show: true, message: 'ç›®æ¨™å·²æ›´æ–°ï¼', color: 'success' };
                    } else {
                        savedGoals.value.push(goalData);
                        snackbar.value = { show: true, message: 'ç›®æ¨™å·²å„²å­˜ï¼', color: 'success' };
                    }
                    saveGoalsToStorage();
                };

                const loadSavedGoal = (goal) => {
                    form.value = {
                        goalType: goal.goalType, currentAge: goal.currentAge, targetAge: goal.targetAge,
                        targetValue: goal.targetValue, currentAssets: goal.currentAssets,
                        monthlyInvestment: goal.monthlyInvestment, strategyReturn: goal.strategyReturn
                    };
                    nextTick(() => {
                        calculate();
                        snackbar.value = { show: true, message: 'å·²è¼‰å…¥ç›®æ¨™ä¸¦é‡æ–°è¨ˆç®—', color: 'info' };
                    });
                };

                const deleteSavedGoal = (index) => {
                    savedGoals.value.splice(index, 1);
                    saveGoalsToStorage();
                    snackbar.value = { show: true, message: 'ç›®æ¨™å·²åˆªé™¤', color: 'success' };
                };
                
                // --- Saved Goal Progress Calculation ---
                const getCalculatedTargetAmount = (goal) => {
                    const goalConfig = goalTypes[goal.goalType];
                    const years = goal.targetAge - goal.currentAge;
                    if (years <= 0) return goal.targetValue * 10000;
                    const targetValueInYuan = goal.targetValue * 10000;
                    if (goalConfig.withdrawRate === 0.04) { // Retirement goal
                        let baseAmount = (targetValueInYuan * 12 / goalConfig.withdrawRate);
                        return Math.round(baseAmount * Math.pow(1 + inflationRate, years));
                    }
                    return targetValueInYuan;
                };

                const calculateGoalProgress = (goal) => {
                    const targetAmountInYuan = getCalculatedTargetAmount(goal);
                    if (targetAmountInYuan <= 0) return 0;
                    const currentAssetsInYuan = goal.currentAssets * 10000;
                    const progress = (currentAssetsInYuan / targetAmountInYuan) * 100;
                    return Math.min(progress, 100);
                };

                // --- Core Calculation Logic ---
                const getGoalAmount = (years) => {
                    const config = currentGoalConfig.value;
                    const targetValueInYuan = form.value.targetValue * 10000;
                    if (config.withdrawRate === 0.04) {
                        let baseAmount = (targetValueInYuan * 12 / config.withdrawRate);
                        return Math.round(baseAmount * Math.pow(1 + inflationRate, years));
                    }
                    return targetValueInYuan;
                };
                
                const projectAssets = (years, annualReturn, monthlyInvest) => {
                    const totalMonths = years * 12;
                    const monthlyReturn = Math.pow(1 + annualReturn, 1/12) - 1;
                    const monthlyInflation = Math.pow(1 + inflationRate, 1/12) - 1;
                    const monthlyRealReturn = (1 + monthlyReturn) / (1 + monthlyInflation) - 1;
                    
                    const currentAssetsYuan = form.value.currentAssets * 10000;
                    const projection = [currentAssetsYuan];
                    
                    for (let year = 1; year <= years; year++) {
                        const monthsToCalculate = year * 12;
                        const futureValueOfCurrentAssets = currentAssetsYuan * Math.pow(1 + monthlyRealReturn, monthsToCalculate);
                        
                        let futureValueOfMonthlyInvestments = 0;
                        if (monthlyRealReturn === 0) {
                            futureValueOfMonthlyInvestments = monthlyInvest * monthsToCalculate;
                        } else {
                            futureValueOfMonthlyInvestments = monthlyInvest * ((Math.pow(1 + monthlyRealReturn, monthsToCalculate) - 1) / monthlyRealReturn);
                        }
                        
                        const totalAssets = futureValueOfCurrentAssets + futureValueOfMonthlyInvestments;
                        projection.push(totalAssets);
                    }
                    
                    return projection;
                };

                const calculateAccumulatedInvestment = (years, monthlyInvest) => {
                    const initialInvestment = form.value.currentAssets * 10000;
                    const accumulated = [initialInvestment];
                    for (let i = 1; i <= years; i++) {
                        accumulated.push(initialInvestment + (monthlyInvest * 12 * i));
                    }
                    return accumulated;
                };

                const calculate = () => {
                    if (form.value.targetAge <= form.value.currentAge) { 
                        snackbar.value = { show: true, message: 'ç›®æ¨™å¹´é½¡å¿…é ˆå¤§æ–¼ç›®å‰å¹´é½¡', color: 'error' };
                        return; 
                    }
                    
                    const years = form.value.targetAge - form.value.currentAge;
                    const goalAmount = getGoalAmount(years);
                    const monthlyInvestYuan = form.value.monthlyInvestment * 10000;
                    const assetsProjection = projectAssets(years, form.value.strategyReturn, monthlyInvestYuan);
                    const investmentProjection = calculateAccumulatedInvestment(years, monthlyInvestYuan);
                    const finalAsset = assetsProjection[assetsProjection.length - 1];
                    
                    results.value = { show: true, isGoalAchieved: finalAsset >= goalAmount, finalAsset, goalAmount, years };
                    
                    if (!results.value.isGoalAchieved) {
                        results.value.requiredReturn = calcRequiredReturn(goalAmount, years);
                        results.value.requiredInvestment = calcRequiredInvestment(goalAmount, years);
                    }
                    
                    updateStrategyRecommendations(goalAmount, years);
                    renderCustomChart(assetsProjection, investmentProjection, goalAmount, years);
                };

                // --- Helper Calculation Functions ---
                const calcRequiredReturn = (target, years) => {
                    let low = 0, high = 0.5;
                    const startAssets = form.value.currentAssets * 10000;
                    const monthlyInvest = form.value.monthlyInvestment * 10000;
                    const totalMonths = years * 12;
                    const monthlyInflation = Math.pow(1 + inflationRate, 1/12) - 1;
                    
                    for (let i = 0; i < 100; i++) {
                        const midAnnualReturn = (low + high) / 2;
                        const midMonthlyReturn = Math.pow(1 + midAnnualReturn, 1/12) - 1;
                        const midMonthlyRealReturn = (1 + midMonthlyReturn) / (1 + monthlyInflation) - 1;
                        
                        const futureValueOfCurrentAssets = startAssets * Math.pow(1 + midMonthlyRealReturn, totalMonths);
                        
                        let futureValueOfMonthlyInvestments = 0;
                        if (midMonthlyRealReturn === 0) {
                            futureValueOfMonthlyInvestments = monthlyInvest * totalMonths;
                        } else {
                            futureValueOfMonthlyInvestments = monthlyInvest * ((Math.pow(1 + midMonthlyRealReturn, totalMonths) - 1) / midMonthlyRealReturn);
                        }
                        
                        const totalValue = futureValueOfCurrentAssets + futureValueOfMonthlyInvestments;
                        
                        if (totalValue > target) high = midAnnualReturn;
                        else low = midAnnualReturn;
                    }
                    return low * 100;
                };

                const calcRequiredInvestment = (target, years) => {
                    const currentReturn = form.value.strategyReturn;
                    const monthlyReturn = Math.pow(1 + currentReturn, 1/12) - 1;
                    const monthlyInflation = Math.pow(1 + inflationRate, 1/12) - 1;
                    const monthlyRealReturn = (1 + monthlyReturn) / (1 + monthlyInflation) - 1;
                    const startAssets = form.value.currentAssets * 10000;
                    const totalMonths = years * 12;
                    
                    const futureValueOfCurrentAssets = startAssets * Math.pow(1 + monthlyRealReturn, totalMonths);
                    const remainingNeeded = target - futureValueOfCurrentAssets;
                    
                    if (remainingNeeded <= 0) return 0;
                    
                    let requiredMonthlyInvestment = 0;
                    if (monthlyRealReturn === 0) {
                        requiredMonthlyInvestment = remainingNeeded / totalMonths;
                    } else {
                        requiredMonthlyInvestment = remainingNeeded * monthlyRealReturn / 
                            (Math.pow(1 + monthlyRealReturn, totalMonths) - 1);
                    }
                    
                    return requiredMonthlyInvestment / 10000;
                };

                // --- Strategy Recommendation Calculation ---
                // MODIFICATION: The function now returns an object with amount and a boolean
                const calculateRequiredMonthlyInvestmentForStrategy = (targetAmount, years, annualReturn) => {
                    const monthlyReturn = Math.pow(1 + annualReturn, 1/12) - 1;
                    const monthlyInflation = Math.pow(1 + inflationRate, 1/12) - 1;
                    const monthlyRealReturn = (1 + monthlyReturn) / (1 + monthlyInflation) - 1;
                    const totalMonths = years * 12;
                    const currentAssetsYuan = form.value.currentAssets * 10000;
                    
                    const futureValueOfCurrentAssets = currentAssetsYuan * Math.pow(1 + monthlyRealReturn, totalMonths);
                    const remainingNeeded = targetAmount - futureValueOfCurrentAssets;
                    
                    if (remainingNeeded <= 0) {
                        return { amount: 0, isMetByInitial: true };
                    }
                    
                    let requiredMonthly = 0;
                    if (monthlyRealReturn === 0) {
                        requiredMonthly = remainingNeeded / totalMonths;
                    } else {
                        requiredMonthly = remainingNeeded * monthlyRealReturn / 
                            (Math.pow(1 + monthlyRealReturn, totalMonths) - 1);
                    }

                    return { amount: requiredMonthly, isMetByInitial: false };
                };
                
                // MODIFICATION: This function now handles the new object structure
                const updateStrategyRecommendations = (goalAmount, years) => {
                    let bestStrategyName = null, lowestScore = Infinity;

                    const recommendations = Object.entries(strategies).map(([name, strategy]) => {
                        const calcResult = calculateRequiredMonthlyInvestmentForStrategy(goalAmount, years, strategy.expectedReturn);
                        return {
                            name,
                            strategy,
                            requiredMonthly: calcResult.amount,
                            isMetByInitial: calcResult.isMetByInitial
                        };
                    });

                    recommendations.forEach(rec => {
                        const totalScore = rec.requiredMonthly + Math.abs(rec.strategy.volatility * 100 - (form.value.strategyReturn * 150)) * 1000;
                        if (totalScore < lowestScore) {
                            lowestScore = totalScore;
                            bestStrategyName = rec.name;
                        }
                    });

                    recommendationResults.value = recommendations.map(rec => ({
                        name: rec.name,
                        expectedReturn: rec.strategy.expectedReturn,
                        requiredMonthly: Math.round(rec.requiredMonthly),
                        reason: strategyReasons[rec.name],
                        isBest: rec.name === bestStrategyName,
                        isMetByInitial: rec.isMetByInitial
                    }));
                };
                
                // --- Interactivity ---
                const selectStrategy = (strategyName) => {
                    const selected = strategies[strategyName];
                    if (!selected) return;
                    const closestOption = strategyOptions.reduce((prev, curr) => Math.abs(curr.value - selected.expectedReturn) < Math.abs(prev.value - selected.expectedReturn) ? curr : prev);
                    form.value.strategyReturn = closestOption.value;
                    if (results.value.show) calculate();
                };

                // --- Chart Rendering with Stacked Bars ---
                const renderCustomChart = (assetsProjection, investmentProjection, goal, totalYears) => {
                    const maxValue = Math.max(goal, ...assetsProjection);
                    
                    const generateChartYears = (totalYears) => {
                        const chartYears = [0, 1];
                        let interval = 5;
                        if (totalYears > 30) interval = 10;
                        if (totalYears > 60) interval = 15;
                        
                        for (let i = interval; i <= totalYears; i += interval) {
                            if (!chartYears.includes(i)) chartYears.push(i);
                        }
                        
                        if (!chartYears.includes(totalYears) && totalYears > 1) {
                            chartYears.push(totalYears);
                        }
                        
                        return chartYears.sort((a, b) => a - b).filter((y, i, arr) => i === 0 || y > arr[i-1]);
                    };
                    
                    const chartYears = generateChartYears(totalYears);
                    
                    const legendHTML = `<div class="chart-legend"><div class="legend-item"><div class="legend-color" style="background: linear-gradient(to top, #3182ce 0%, #4299e1 100%);"></div><span>ç´¯ç©æŠ•è³‡æˆæœ¬</span></div><div class="legend-item"><div class="legend-color" style="background: linear-gradient(to top, #208065 0%, #40A080 100%);"></div><span>æŠ•è³‡å¢é•·æ”¶ç›Š</span></div></div>`;
                    
                    let barsHTML = chartYears.map(year => {
                        const totalAsset = assetsProjection[year];
                        const totalInvestment = investmentProjection[year];
                        const growth = totalAsset - totalInvestment;
                        const investmentHeight = (totalInvestment / maxValue) * 300;
                        const growthHeight = (growth / maxValue) * 300;
                        const tooltipContent = `<strong>ç¸½è³‡ç”¢:</strong> ${Math.round(totalAsset / 10000)}è¬<br><strong>ç´¯ç©æŠ•è³‡æˆæœ¬:</strong> ${Math.round(totalInvestment / 10000)}è¬<br><strong>æŠ•è³‡å¢é•·æ”¶ç›Š:</strong> ${Math.round(growth / 10000)}è¬`;
                        return `<div class="bar" style="height: ${investmentHeight + growthHeight}px;" onmouseover='window.appInstance.showTooltip(event, "${tooltipContent}")' onmousemove="window.appInstance.moveTooltip(event)" onmouseout="window.appInstance.hideTooltip()"><div class="bar-value">${Math.round(totalAsset / 10000)}è¬</div><div class="bar-segment growth" style="height: ${growthHeight}px;"></div><div class="bar-segment investment" style="height: ${investmentHeight}px;"></div></div>`;
                    }).join('');
                    
                    let labelsHTML = chartYears.map(year => {
                        if (year === 0) {
                            return `<div class="bar-label">èµ·å§‹é‡‘é¡</div>`;
                        } else {
                            return `<div class="bar-label"><span class="year-text">${year}å¹´å¾Œ</span><span class="age-text">(${form.value.currentAge + year}æ­²)</span></div>`;
                        }
                    }).join('');
                    
                    chartHTML.value = `${legendHTML}<div class="bar-chart"><div class="bars-container"><div class="goal-line" style="bottom: ${(goal / maxValue) * 300}px;"><div class="goal-label">ç›®æ¨™ ${Math.round(goal/10000)}è¬</div></div>${barsHTML}</div><div class="labels-container">${labelsHTML}</div></div>`;
                };

                return { 
                    theme, form, results, chartHTML, recommendationResults, savedGoals, isLoggedIn, snackbar,
                    goalTypes, pageTitle, targetCurrentAge, targetAgeLabel, targetAmountLabel, resultsTitle, 
                    calculateButtonText, goalOptions, strategyOptions, strategies, calculate, selectStrategy,
                    saveGoal, loadSavedGoal, deleteSavedGoal, showTooltip, moveTooltip, hideTooltip,
                    getCalculatedTargetAmount, calculateGoalProgress
                };
            }
        });
        
        const vm = app.use(vuetify).mount('#app');
        window.appInstance = vm; // Expose Vue instance to window for inline event handlers
    </script>
</body>
</html>
