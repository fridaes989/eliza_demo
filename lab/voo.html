<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>巴菲特推薦策略回測 - 墨鏡姐複利樹</title>
    <link href="https://cdn.jsdelivr.net/npm/vuetify@3.4.0/dist/vuetify.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@mdi/font@5.x/css/materialdesignicons.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <link rel="stylesheet" href="src/style.css">
</head>

<body>
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <h3>載入中...</h3>
            <p>正在載入即時資訊</p>
        </div>
    </div>
    <div id="app">
        <v-app :theme="theme">
            <v-main>
                <v-container>
                    <v-row justify="center">
                        <v-toolbar color="transparent">
                            <v-toolbar-title class="text-h5 font-weight-bold text-primary">墨鏡姐複利樹</v-toolbar-title>
                            <v-spacer></v-spacer>
                            <v-btn text href="goal.html">財務規劃</v-btn>
                            <v-btn text href="all_weather.html">全天候策略</v-btn>
                            <v-btn text href="classic3.html">三基金組合</v-btn>
                            <v-btn text href="aggressive.html">積極型股債組合</v-btn>
                            <v-btn text href="core4.html">核心四基金</v-btn>
                            <v-btn text href="voo.html" variant="tonal" color="primary">巴菲特推薦</v-btn>
                        </v-toolbar>

                            <v-card class="mt-4" flat color="transparent">
                               <v-card-text>
                                <v-col cols="12" md="5">
                                    <h1>巴菲特推薦策略</h1>
                                  </v-col>
                                 <v-row>
                                    <!-- Performance & Allocation -->
                                    <v-col cols="12" md="5">
                                        <v-row>
                                            <v-col cols="12">
                                                <v-card>
                                                    <v-card-title>績效表現</v-card-title>
                                                    <v-row dense class="pa-2">
                                                        <v-col cols="12" sm="6"><v-card color="surface-variant" flat><v-card-text><div class="text-caption">年化報酬率 (估)</div><div class="text-h5 font-weight-bold text-primary">{{ pct(portfolio.data.CAGR) }}</div></v-card-text></v-card></v-col>
                                                        <v-col cols="12" sm="6"><v-card color="surface-variant" flat><v-card-text><div class="text-caption">年化波動率</div><div class="text-h5 font-weight-bold text-white">{{ pct(portfolio.data.volatility) }}</div></v-card-text></v-card></v-col>
                                                        <v-col cols="12"><v-card color="surface-variant" flat><v-card-text><div class="text-caption">最大回撤</div><div class="text-h5 font-weight-bold text-error">{{ pct(portfolio.data.maxDrawdown) }}</div></v-card-text></v-card></v-col>
                                                    </v-row>
                                                </v-card>
                                            </v-col>
                                            <v-col cols="12">
                                                <v-card>
                                                    <v-card-title>組成標的與比例</v-card-title>
                                                    <v-card-text>
                                                        <div class="pie-chart-container"><canvas id="pie-chart"></canvas></div>
                                                        <v-row dense class="mt-4">
                                                            <v-col v-for="(percent, asset) in portfolio.data.allocations" :key="asset" cols="12" sm="6">
                                                                <div class="legend-item">
                                                                    <div class="legend-color" :style="{ backgroundColor: pieColors[Object.keys(portfolio.data.allocations).indexOf(asset)] }"></div>
                                                                    <div>{{ asset }}: {{ percent }}%</div>
                                                                </div>
                                                            </v-col>
                                                        </v-row>
                                                    </v-card-text>
                                                </v-card>
                                            </v-col>
                                        </v-row>
                                    </v-col>
                                    <!-- Backtest & Projection -->
                                    <v-col cols="12" md="7">
                                        <v-card class="h-100">
                                            <v-card-title>歷史回測 (與 S&P 500 比較)</v-card-title>
                                            <v-card-text>
                                                <v-chip-group v-model="backtestYears" mandatory color="primary">
                                                    <v-chip :value="3">近 3 年</v-chip>
                                                    <v-chip :value="5">近 5 年</v-chip>
                                                    <v-chip :value="10">近 10 年</v-chip>
                                                </v-chip-group>
                                                <div style="height: 380px;"><canvas id="backtest-chart"></canvas></div>
                                            </v-card-text>
                                        </v-card>
                                    </v-col>
                              
                                 </v-row>
                               </v-card-text>
                            </v-card>
                        </v-col>
                    </v-row>
                </v-container>
            </v-main>
        </v-app>
    </div>

    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vuetify@3.4.0/dist/vuetify.min.js"></script>
    <script>
              // Loading management
              document.addEventListener('DOMContentLoaded', function() {
            // Simulate loading time for libraries and ensure smooth transition
            setTimeout(() => {
                const loadingOverlay = document.getElementById('loadingOverlay');
                const app = document.getElementById('app');
                
                loadingOverlay.style.opacity = '0';
                app.style.opacity = '1';
                
                setTimeout(() => {
                    loadingOverlay.style.display = 'none';
                }, 500);
            }, 1500);
        });



        const { createApp, ref, watch, onMounted, nextTick } = Vue;
        const { createVuetify } = Vuetify;

        const customDarkTheme = { dark: true, colors: { background: '#0D0D0D', surface: '#000', 'surface-variant': 'rgba(0,0,0,0.1)', primary: '#208065', secondary: '#806420', error: '#CF6679' } };
        const vuetify = createVuetify({ theme: { defaultTheme: 'dark', themes: { dark: customDarkTheme } } });

        createApp({
            setup() {
                const theme = ref('dark');
                // Updated portfolio for Core Four Funds strategy
                const portfolio = { 
                    name: "巴菲特推薦策略", 
                    data: { 
                        allocations: { 
                            VOO: 100,    // Total Stock Market Index Fund
                        }, 
                        CAGR: 0.144,        // Estimated annual return
                        volatility: 0.153,   // Annual volatility
                        maxDrawdown: -0.339   // Maximum drawdown
                    } 
                };

                // CSV data for Core Four Funds backtest - you should replace this with actual core4_backtest.csv data
                const csvData = `date,portfolio_monthly_return,portfolio_value,sp500_value             
                                2010-09,0,10000,10000
2010-10,0.03,10308,10310
2010-11,-0.01,10239,10260
2010-12,0.05,10734,10740
2011-01,0.02,10904,10909
2011-02,0.03,11209,11221
2011-03,-0.01,11114,11140
2011-04,0.02,11369,11394
2011-05,-0.02,11186,11214
2011-06,-0.02,10972,10999
2011-07,-0.02,10743,10769
2011-08,-0.07,10008,10051
2011-09,-0.07,9270,9300
2011-10,0.11,10323,10374
2011-11,0.03,10582,10619
2011-12,0.01,10714,10741
2012-01,0.03,11002,11046
2012-02,0.03,11385,11445
2012-03,0.03,11716,11785
2012-04,-0.01,11637,11724
2012-05,-0.06,10937,11026
2012-06,0.06,11558,11643
2012-07,0.01,11662,11747
2012-08,0.02,11876,11954
2012-09,0.03,12193,12267
2012-10,-0.02,11914,11994
2012-11,0,11936,12040
2012-12,0,11905,12009
2013-01,0.03,12282,12396
2013-02,0.01,12363,12476
2013-03,0.04,12864,12992
2013-04,0.02,13121,13248
2013-05,0.03,13462,13592
2013-06,-0.02,13228,13381
2013-07,0.05,13833,14000
2013-08,-0.04,13293,13473
2013-09,0.02,13528,13699
2013-10,1.09,28263,14325
2013-11,0.03,29032,14732
2013-12,0.02,29593,15025
2014-01,-0.03,28655,14553
2014-02,0.05,29994,15234
2014-03,0.01,30379,15422
2014-04,0,30508,15482
2014-05,0.02,31227,15846
2014-06,0.01,31680,16076
2014-07,-0.02,31154,15825
2014-08,0.04,32469,16492
2014-09,-0.02,31817,16169
2014-10,0.03,32635,16576
2014-11,0.03,33481,17008
2014-12,0,33324,16979
2015-01,-0.03,32213,16408
2015-02,0.05,33917,17274
2015-03,-0.02,33199,16917
2015-04,0.01,33537,17087
2015-05,0.01,33809,17227
2015-06,-0.03,32866,16732
2015-07,0.01,33267,16955
2015-08,-0.06,31211,15926
2015-09,-0.01,30970,15805
2015-10,0.08,33538,17114
2015-11,0,33609,17144
2015-12,-0.03,32712,16688
2016-01,-0.03,31656,16136
2016-02,0,31794,16222
2016-03,0.05,33531,17104
2016-04,0.01,33864,17267
2016-05,0.01,34360,17511
2016-06,0,34417,17539
2016-07,0.04,35707,18191
2016-08,0,35734,18208
2016-09,0,35590,18118
2016-10,-0.02,35050,17843
2016-11,0.04,36277,18467
2016-12,0.02,36972,18810
2017-01,0.01,37384,19019
2017-02,0.04,38715,19706
2017-03,-0.01,38255,19481
2017-04,0.01,38625,19669
2017-05,0.01,39071,19899
2017-06,0,39051,19883
2017-07,0.02,39673,20202
2017-08,0,39673,20205
2017-09,0.02,40402,20575
2017-10,0.02,41298,21038
2017-11,0.03,42400,21608
2017-12,0.01,42960,21887
2018-01,0.05,45211,23039
2018-02,-0.03,43644,22270
2018-03,-0.03,42540,21684
2018-04,0.01,42847,21844
2018-05,0.03,43966,22428
2018-06,0,44045,22436
2018-07,0.04,45958,23415
2018-08,0.03,47400,24142
2018-09,0.01,47738,24324
2018-10,-0.07,44224,22529
2018-11,0.02,44904,22867
2018-12,-0.11,39973,20346
2019-01,0.1,43771,22295
2019-02,0.03,45135,23002
2019-03,0.01,45695,23270
2019-04,0.03,47201,24040
2019-05,-0.07,44087,22447
2019-06,0.07,47160,24000
2019-07,0,47274,24059
2019-08,-0.02,46459,23643
2019-09,0.02,47452,24144
2019-10,0.02,48342,24599
2019-11,0.03,49835,25360
2019-12,0.02,51003,25947
2020-01,-0.01,50730,25800
2020-02,-0.09,46376,23629
2020-03,-0.14,40029,20403
2020-04,0.17,46650,23768
2020-05,0.07,49726,25323
2020-06,0.02,50503,25718
2020-07,0.06,53307,27132
2020-08,0.06,56748,28875
2020-09,-0.04,54245,27608
2020-10,-0.03,52421,26689
2020-11,0.1,57538,29292
2020-12,0.02,58884,29965
2021-01,-0.01,58054,29545
2021-02,0.02,59070,30074
2021-03,0.03,60715,30923
2021-04,0.05,63613,32398
2021-05,0,63708,32447
2021-06,0.01,64537,32871
2021-07,0.02,65989,33611
2021-08,0.03,67671,34471
2021-09,-0.05,64140,32684
2021-10,0.07,68359,34838
2021-11,-0.01,67692,34478
2021-12,0.03,69647,35485
2022-01,-0.06,65779,33513
2022-02,-0.03,63715,32466
2022-03,0.04,66121,33701
2022-04,-0.09,60072,30618
2022-05,0,60214,30682
2022-06,-0.09,54698,27864
2022-07,0.09,59843,30481
2022-08,-0.03,57794,29447
2022-09,-0.09,52574,26786
2022-10,0.07,56283,28671
2022-11,0.04,58813,29973
2022-12,-0.06,55242,28174
2023-01,0.06,58428,29803
2023-02,-0.02,57125,29147
2023-03,0.03,59122,30175
2023-04,0.02,60136,30697
2023-05,0.01,60476,30873
2023-06,0.06,64112,32734
2023-07,0.03,66278,33832
2023-08,-0.01,65422,33394
2023-09,-0.05,61916,31608
2023-10,-0.02,60697,30985
2023-11,0.09,66118,33741
2023-12,0.05,69223,35322
2024-01,0.02,70793,36118
2024-02,0.05,74235,37872
2024-03,0.03,76520,39040
2024-04,-0.04,73334,37409
2024-05,0.05,77125,39346
2024-06,0.03,79600,40607
2024-07,0.01,80306,40994
2024-08,0.02,81926,41821
2024-09,0.02,83910,42806
2024-10,-0.01,83215,42451
2024-11,0.05,87720,44783
2024-12,-0.03,85255,43527
2025-01,0.02,87060,44451
2025-02,0,87271,44562
2025-03,-0.06,81794,41803
2025-04,-0.01,81377,41586
2025-05,0.05,85628,43762
2025-06,0.05,90019,45996
2025-07,0.03,92310,47166
2025-08,0.03,95067,48565
2025-09,0,95492,48774`;

                const backtestData = ref([]);
                const backtestYears = ref(3);
                const projectionYears = ref(10);
                const form = ref({ initial: 100000, monthly: 10000 });
                const projectionResult = ref({ invested: 0, value: 0 });
                const pieColors = ['#208065', '#40A080', '#60C0A0', '#80E0C0', '#A0FFA0', '#806420'];
                const charts = {};

                const parseCSV = (csv) => { const lines = csv.trim().split('\n'); const headers = lines.shift().split(','); return lines.map(line => { const values = line.split(','); const entry = {}; headers.forEach((h, i) => { entry[h.trim()] = isNaN(Number(values[i])) ? values[i] : Number(values[i]); }); return entry; }); };
                const createOrUpdateChart = (id, config) => { if (charts[id]) { charts[id].data = config.data; charts[id].options = config.options; charts[id].update(); } else { const ctx = document.getElementById(id)?.getContext('2d'); if (ctx) charts[id] = new Chart(ctx, config); } };
                const drawPieChart = () => createOrUpdateChart('pie-chart', { type: 'doughnut', data: { labels: Object.keys(portfolio.data.allocations), datasets: [{ data: Object.values(portfolio.data.allocations), backgroundColor: pieColors, borderWidth: 2, borderColor: '#0D0D0D' }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } } });
                const drawBacktestChart = () => { const slicedData = backtestData.value.slice(-(backtestYears.value * 12)); createOrUpdateChart('backtest-chart', { type: 'line', data: { labels: slicedData.map(d => d.date), datasets: [{ label: portfolio.name, data: slicedData.map(d => d.portfolio_value), borderColor: '#208065', tension: 0.1, pointRadius: 0 }, { label: 'S&P 500', data: slicedData.map(d => d.sp500_value), borderColor: '#806420', tension: 0.1, pointRadius: 0 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { x: { ticks: { color: '#FFF' } }, y: { ticks: { color: '#FFF', callback: v => formatK(v) } } }, plugins: { legend: { labels: { color: '#FFF' } } } } }); };
                const drawProjectionChart = () => { const { data, invested, value } = buildProjectionSeries(); projectionResult.value = { invested, value }; createOrUpdateChart('projection-chart', { type: 'line', data: { labels: data.map(d => d.year), datasets: [{ label: '累積投入', data: data.map(d => d.invested), borderColor: '#806420', backgroundColor: 'rgba(128, 100, 32, 0.2)', fill: true, tension: 0.1 }, { label: '資產總額', data: data.map(d => d.value), borderColor: '#208065', backgroundColor: 'rgba(32, 128, 101, 0.2)', fill: true, tension: 0.1 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { x: { ticks: { color: '#FFF' } }, y: { ticks: { color: '#FFF', callback: v => formatK(v) } } }, plugins: { legend: { labels: { color: '#FFF' } } } } }); };
                const buildProjectionSeries = () => { const { initial, monthly } = form.value; const data = []; let invested = initial, value = initial; const r = Math.pow(1 + portfolio.data.CAGR, 1 / 12) - 1; for (let y = 1; y <= projectionYears.value; y++) { for (let i = 0; i < 12; i++) { value = (value + monthly) * (1 + r); invested += monthly; } data.push({ year: `${y}年`, invested: Math.round(invested), value: Math.round(value) }); } return { data, invested, value }; };
                const formatK = (num) => { if (Math.abs(num) >= 1e6) return (num / 1e6).toFixed(2) + 'M'; if (Math.abs(num) >= 1e3) return (num / 1e3).toFixed(1) + 'K'; return num.toLocaleString(); };
                const pct = (n) => (n * 100).toFixed(1) + '%';
                
                watch(backtestYears, drawBacktestChart);
                watch([form, projectionYears], drawProjectionChart, { deep: true });
                onMounted(() => { backtestData.value = parseCSV(csvData); nextTick(() => { drawPieChart(); drawBacktestChart(); drawProjectionChart(); }); });

                return { theme, portfolio, backtestYears, projectionYears, form, projectionResult, pieColors, formatK, pct };
            }
        }).use(vuetify).mount('#app');
    </script>
</body>
</html>
