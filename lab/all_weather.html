<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>全天候策略回測 - 墨鏡姐複利樹</title>
    <link href="https://cdn.jsdelivr.net/npm/vuetify@3.4.0/dist/vuetify.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@mdi/font@5.x/css/materialdesignicons.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <link rel="stylesheet" href="src/style.css">
</head>

<body>
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <h3>載入中...</h3>
            <p>正在載入即時資訊</p>
        </div>
    </div>
    <div id="app">
        <v-app :theme="theme">
            <v-main>
                <v-container>
                    <v-row justify="center">
                        <v-col cols="12" md="11" lg="10">
                            <v-toolbar color="transparent">
                                <v-toolbar-title class="text-h5 font-weight-bold text-primary">墨鏡姐複利樹</v-toolbar-title>
                                <v-spacer></v-spacer>
                                <v-btn text href="goal.html">財務規劃</v-btn>
                                <v-btn text href="all_weather.html"  variant="tonal" color="primary">全天候策略</v-btn>
                                <v-btn text href="classic3.html">三基金組合</v-btn>
                                <v-btn text href="aggressive.html">積極型股債組合</v-btn>
                                <v-btn text href="core4.html">核心四基金</v-btn>
                                <v-btn text href="voo.html">巴菲特推薦</v-btn>
                            </v-toolbar>


                            <v-card class="mt-4" flat color="transparent">
                               <v-card-text>
                                <v-col cols="12" md="5">
                                    <h1>全天候策略</h1>
                                  </v-col>
                                 <v-row>
                                    <!-- Performance & Allocation -->
                                    <v-col cols="12" md="5">
                                        <v-row>
                                            <v-col cols="12">
                                                <v-card>
                                                    <v-card-title>績效表現</v-card-title>
                                                    <v-row dense class="pa-2">
                                                        <v-col cols="12" sm="6"><v-card color="surface-variant" flat><v-card-text><div class="text-caption">年化報酬率 (估)</div><div class="text-h5 font-weight-bold text-primary">{{ pct(portfolio.data.CAGR) }}</div></v-card-text></v-card></v-col>
                                                        <v-col cols="12" sm="6"><v-card color="surface-variant" flat><v-card-text><div class="text-caption">年化波動率</div><div class="text-h5 font-weight-bold text-white">{{ pct(portfolio.data.volatility) }}</div></v-card-text></v-card></v-col>
                                                        <v-col cols="12"><v-card color="surface-variant" flat><v-card-text><div class="text-caption">最大回撤</div><div class="text-h5 font-weight-bold text-error">{{ pct(portfolio.data.maxDrawdown) }}</div></v-card-text></v-card></v-col>
                                                    </v-row>
                                                </v-card>
                                            </v-col>
                                            <v-col cols="12">
                                                <v-card>
                                                    <v-card-title>組成標的與比例</v-card-title>
                                                    <v-card-text>
                                                        <div class="pie-chart-container"><canvas id="pie-chart"></canvas></div>
                                                        <v-row dense class="mt-4">
                                                            <v-col v-for="(percent, asset) in portfolio.data.allocations" :key="asset" cols="12" sm="6">
                                                                <div class="legend-item">
                                                                    <div class="legend-color" :style="{ backgroundColor: pieColors[Object.keys(portfolio.data.allocations).indexOf(asset)] }"></div>
                                                                    <div>{{ asset }}: {{ percent }}%</div>
                                                                </div>
                                                            </v-col>
                                                        </v-row>
                                                    </v-card-text>
                                                </v-card>
                                            </v-col>
                                        </v-row>
                                    </v-col>
                                    <!-- Backtest & Projection -->
                                    <v-col cols="12" md="7">
                                        <v-card class="h-100">
                                            <v-card-title>歷史回測 (與 S&P 500 比較)</v-card-title>
                                            <v-card-text>
                                                <v-chip-group v-model="backtestYears" mandatory color="primary">
                                                    <v-chip :value="3">近 3 年</v-chip>
                                                    <v-chip :value="5">近 5 年</v-chip>
                                                    <v-chip :value="10">近 10 年</v-chip>
                                                </v-chip-group>
                                                <div style="height: 380px;"><canvas id="backtest-chart"></canvas></div>
                                            </v-card-text>
                                        </v-card>
                                    </v-col>
                              
                                 </v-row>
                               </v-card-text>
                            </v-card>
                        </v-col>
                    </v-row>
                </v-container>
            </v-main>
        </v-app>
    </div>

    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vuetify@3.4.0/dist/vuetify.min.js"></script>
    <script>
              // Loading management
              document.addEventListener('DOMContentLoaded', function() {
            // Simulate loading time for libraries and ensure smooth transition
            setTimeout(() => {
                const loadingOverlay = document.getElementById('loadingOverlay');
                const app = document.getElementById('app');
                
                loadingOverlay.style.opacity = '0';
                app.style.opacity = '1';
                
                setTimeout(() => {
                    loadingOverlay.style.display = 'none';
                }, 500);
            }, 1500);
        });



        const { createApp, ref, watch, onMounted, nextTick } = Vue;
        const { createVuetify } = Vuetify;

        const customDarkTheme = { dark: true, colors: { background: '#0D0D0D', surface: '#000', 'surface-variant': 'rgba(0,0,0,0.1)', primary: '#208065', secondary: '#806420', error: '#CF6679' } };
        const vuetify = createVuetify({ theme: { defaultTheme: 'dark', themes: { dark: customDarkTheme } } });

        createApp({
            setup() {
                const theme = ref('dark');
                const portfolio = { name: "全天候策略", data: { allocations: { VTI: 30, TLT: 40, IEF: 15, GLD: 7.5, GSG: 7.5 }, CAGR: 0.0518, volatility: 0.0894, maxDrawdown: -0.225 } };
                const csvData = `date,portfolio_monthly_return,portfolio_value,sp500_value\n2015-09,0.0,10000,10000\n2015-10,2.271599,10227,10852\n2015-11,-1.414426,10083,10891\n2015-12,-1.502895,9931,10704\n2016-01,1.015771,10032,10171\n2016-02,2.111957,10244,10162\n2016-03,2.381067,10488,10846\n2016-04,1.046763,10597,10887\n2016-05,0.443005,10644,11073\n2016-06,4.052757,11076,11112\n2016-07,1.464033,11238,11517\n2016-08,-0.576424,11173,11531\n2016-09,-0.147926,11157,11532\n2016-10,-3.005617,10821,11331\n2016-11,-3.012744,10495,11749\n2016-12,0.627506,10561,11986\n2017-01,1.19988,10688,12201\n2017-02,2.114288,10914,12682\n2017-03,-0.575309,10851,12696\n2017-04,1.040918,10964,12822\n2017-05,1.086254,11083,13005\n2017-06,0.244509,11110,13087\n2017-07,0.837561,11203,13356\n2017-08,1.86375,11412,13395\n2017-09,-0.426925,11363,13665\n2017-10,0.84423,11459,13987\n2017-11,1.281231,11606,14414\n2017-12,1.542012,11785,14589\n2018-01,0.471687,11841,15410\n2018-02,-2.918872,11495,14851\n2018-03,0.950287,11604,14444\n2018-04,-0.622368,11532,14518\n2018-05,1.802512,11740,14871\n2018-06,0.327534,11778,14958\n2018-07,-0.122761,11764,15513\n2018-08,1.637296,11956,16007\n2018-09,-1.038716,11832,16102\n2018-10,-3.743872,11389,14990\n2018-11,0.717245,11471,15267\n2018-12,-0.160578,11453,13922\n2019-01,3.646326,11870,15036\n2019-02,0.662051,11949,15526\n2019-03,3.037201,12312,15805\n2019-04,0.459212,12368,16452\n2019-05,0.760011,12462,15401\n2019-06,3.607017,12912,16474\n2019-07,0.498755,12976,16722\n2019-08,4.61607,13575,16443\n2019-09,-0.85698,13459,16763\n2019-10,0.466375,13522,17133\n2019-11,0.664411,13611,17753\n2019-12,0.173018,13635,18269\n2020-01,3.123151,14061,18261\n2020-02,0.05794,14069,16817\n2020-03,-3.348366,13598,14717\n2020-04,4.352715,14190,16586\n2020-05,2.325617,14520,17376\n2020-06,1.454857,14731,17684\n2020-07,4.71578,15426,18725\n2020-08,0.287759,15470,20032\n2020-09,-1.360513,15260,19282\n2020-10,-2.444568,14886,18802\n2020-11,4.761613,15595,20846\n2020-12,1.826644,15880,21619\n2021-01,-1.605009,15625,21399\n2021-02,-1.412703,15405,21994\n2021-03,-1.60122,15158,22993\n2021-04,3.53574,15694,24209\n2021-05,0.948354,15843,24368\n2021-06,2.425063,16227,24915\n2021-07,2.592349,16648,25523\n2021-08,0.467012,16725,26283\n2021-09,-2.543278,16300,25057\n2021-10,3.474466,16866,26816\n2021-11,-0.019095,16863,26600\n2021-12,1.028191,17036,27831\n2022-01,-2.945627,16535,26363\n2022-02,-0.33398,16479,25585\n2022-03,-1.06482,16304,26547\n2022-04,-6.974184,15167,24217\n2022-05,-0.698237,15061,24272\n2022-06,-3.82516,14485,22270\n2022-07,3.94803,15057,24321\n2022-08,-3.962692,14460,23329\n2022-09,-7.57795,13364,21172\n2022-10,0.129997,13382,22893\n2022-11,5.502732,14118,24166\n2022-12,-3.127028,13677,22773\n2023-01,6.0976,14510,24205\n2023-02,-3.903884,13944,23597\n2023-03,3.674739,14456,24472\n2023-04,0.536534,14534,24863\n2023-05,-1.896712,14258,24977\n2023-06,1.923189,14533,26596\n2023-07,0.931534,14668,27467\n2023-08,-2.044453,14368,27020\n2023-09,-5.310268,13605,25739\n2023-10,-3.046817,13191,25180\n2023-11,7.294343,14153,27480\n2023-12,5.137618,14880,28734\n2024-01,-0.329659,14831,29192\n2024-02,0.439259,14896,30715\n2024-03,2.236529,15229,31720\n2024-04,-4.101526,14604,30441\n2024-05,2.198621,14925,31981\n2024-06,2.357825,15277,33109\n2024-07,2.592874,15674,33510\n2024-08,1.633057,15929,34293\n2024-09,1.844435,16223,35013\n2024-10,-2.528466,15813,34701\n2024-11,2.620457,16227,36770\n2024-12,-3.871746,15599,35885\n2025-01,1.966614,15906,36849\n2025-02,2.109935,16242,36381\n2025-03,-1.425067,16010,34354\n2025-04,-0.91326,15864,34056\n2025-05,0.504951,15944,36196\n2025-06,3.048363,16430,37944\n2025-07,0.160515,16456,38818\n2025-08,0.315056,16508,39188`;
                const backtestData = ref([]);
                const backtestYears = ref(3);
                const projectionYears = ref(10);
                const form = ref({ initial: 100000, monthly: 10000 });
                const projectionResult = ref({ invested: 0, value: 0 });
                const pieColors = ['#208065', '#40A080', '#60C0A0', '#80E0C0', '#A0FFA0', '#806420'];
                const charts = {};

                const parseCSV = (csv) => { const lines = csv.trim().split('\n'); const headers = lines.shift().split(','); return lines.map(line => { const values = line.split(','); const entry = {}; headers.forEach((h, i) => { entry[h.trim()] = isNaN(Number(values[i])) ? values[i] : Number(values[i]); }); return entry; }); };
                const createOrUpdateChart = (id, config) => { if (charts[id]) { charts[id].data = config.data; charts[id].options = config.options; charts[id].update(); } else { const ctx = document.getElementById(id)?.getContext('2d'); if (ctx) charts[id] = new Chart(ctx, config); } };
                const drawPieChart = () => createOrUpdateChart('pie-chart', { type: 'doughnut', data: { labels: Object.keys(portfolio.data.allocations), datasets: [{ data: Object.values(portfolio.data.allocations), backgroundColor: pieColors, borderWidth: 2, borderColor: '#0D0D0D' }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } } });
                const drawBacktestChart = () => { const slicedData = backtestData.value.slice(-(backtestYears.value * 12)); createOrUpdateChart('backtest-chart', { type: 'line', data: { labels: slicedData.map(d => d.date), datasets: [{ label: portfolio.name, data: slicedData.map(d => d.portfolio_value), borderColor: '#208065', tension: 0.1, pointRadius: 0 }, { label: 'S&P 500', data: slicedData.map(d => d.sp500_value), borderColor: '#806420', tension: 0.1, pointRadius: 0 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { x: { ticks: { color: '#FFF' } }, y: { ticks: { color: '#FFF', callback: v => formatK(v) } } }, plugins: { legend: { labels: { color: '#FFF' } } } } }); };
                const drawProjectionChart = () => { const { data, invested, value } = buildProjectionSeries(); projectionResult.value = { invested, value }; createOrUpdateChart('projection-chart', { type: 'line', data: { labels: data.map(d => d.year), datasets: [{ label: '累積投入', data: data.map(d => d.invested), borderColor: '#806420', backgroundColor: 'rgba(128, 100, 32, 0.2)', fill: true, tension: 0.1 }, { label: '資產總額', data: data.map(d => d.value), borderColor: '#208065', backgroundColor: 'rgba(32, 128, 101, 0.2)', fill: true, tension: 0.1 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { x: { ticks: { color: '#FFF' } }, y: { ticks: { color: '#FFF', callback: v => formatK(v) } } }, plugins: { legend: { labels: { color: '#FFF' } } } } }); };
                const buildProjectionSeries = () => { const { initial, monthly } = form.value; const data = []; let invested = initial, value = initial; const r = Math.pow(1 + portfolio.data.CAGR, 1 / 12) - 1; for (let y = 1; y <= projectionYears.value; y++) { for (let i = 0; i < 12; i++) { value = (value + monthly) * (1 + r); invested += monthly; } data.push({ year: `${y}年`, invested: Math.round(invested), value: Math.round(value) }); } return { data, invested, value }; };
                const formatK = (num) => { if (Math.abs(num) >= 1e6) return (num / 1e6).toFixed(2) + 'M'; if (Math.abs(num) >= 1e3) return (num / 1e3).toFixed(1) + 'K'; return num.toLocaleString(); };
                const pct = (n) => (n * 100).toFixed(1) + '%';
                
                watch(backtestYears, drawBacktestChart);
                watch([form, projectionYears], drawProjectionChart, { deep: true });
                onMounted(() => { backtestData.value = parseCSV(csvData); nextTick(() => { drawPieChart(); drawBacktestChart(); drawProjectionChart(); }); });

                return { theme, portfolio, backtestYears, projectionYears, form, projectionResult, pieColors, formatK, pct };
            }
        }).use(vuetify).mount('#app');
    </script>
</body>
</html>
