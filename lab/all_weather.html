<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
  <title>投資組合回測 - 全天候策略</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <link rel="stylesheet" href="src/style.css">
</head>
<body>
  <div class="container">
    <div class="header">
        <h1>投資組合回測</h1>
        <div class="tab-buttons">
          <a href="all_weather.html" class="tab-button active">全天候策略</a>
          <a href="classic3.html" class="tab-button">三基金組合</a>
          <a href="aggressive.html" class="tab-button">積極型股債組合</a>
        </div>
      
     </div>

    <div class="two-column">
      <div class="performance-section row">
        <div class="performance-row col-12">
          <div class="card dark1 col-6">
            <div class="metric-label">報酬</div>
            <div class="metric-card">
              <div class="metric-label">年化報酬率（估）</div>
              <div class="metric-value" id="annualReturn">7.8%</div>
            </div>
            <div class="metric-card" style="margin-top:12px;">
              <div class="metric-label">總報酬率（估）</div>
              <div class="metric-value" id="totalReturnPct">0.0%</div>
            </div>
          </div>
          <div class="card dark1 col-6">
            <div class="metric-label">風險（估）</div>
            <div class="metric-card">
              <div class="metric-label">年化波動率</div>
              <div class="metric-value" id="volatility">9.2%</div>
            </div>
            <div class="metric-card" style="margin-top:8px;">
              <div class="metric-label">最大回撤</div>
              <div class="metric-value" id="maxDrawdown">-28.0%</div>
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <h2 class="chart-title">組成標的與比例</h2>
        <div class="allocation-display">
          <div class="pie-chart-container">
            <canvas id="pieChart"></canvas>
          </div>
          <div id="allocationLegend" class="allocation-legend"></div>
        </div>
      </div>
    </div>

    <div class="card dark2">
      <div class="inline-controls" style="justify-content:space-between; margin-bottom:8px;">
        <div class="inline-controls">
          <div class="chart-title">歷史回測（與 S&P 500 比較）</div>
          <button class="chip backtest-years active" data-years="3">近 3 年</button>
          <button class="chip backtest-years" data-years="5">近 5 年</button>
          <button class="chip backtest-years" data-years="10">近 10 年</button>
        </div>
        <div class="switch" title="股利處理方式">
          <label style="font-size:12px; opacity:.8;">股利處理：</label>
          <label><input type="radio" name="divMode" value="drip" checked> DRIP（股利再投入）</label>
          <label><input type="radio" name="divMode" value="cash"> 現金發放</label>
        </div>
      </div>
      <div class="chart-container backtest-container">
        <canvas id="backtestChart"></canvas>
      </div>
    </div>

    <div class="two-column">
      <div class="input-section">
        <h3 class="chart-title">投資參數設定</h3>
        <div class="input-grid">
          <div class="input-group">
            <label>初期投入</label>
            <input type="number" id="initial" value="100000" min="0" />
          </div>
          <div class="input-group">
            <label>每月定投</label>
            <input type="number" id="monthly" value="10000" min="0" />
          </div>
          <div class="input-group">
            <label>目標金額</label>
            <input type="number" id="target" value="1000000" min="0" />
          </div>
        </div>
        
        <div class="inline-controls" style="gap:8px;">
          <div class="chart-title">投資曲線期間</div>
          <button class="chip horizon-years" data-years="3">3 年</button>
          <button class="chip horizon-years" data-years="5">5 年</button>
          <button class="chip horizon-years active" data-years="10">10 年</button>
          <button class="chip horizon-years" data-years="20">20 年</button>
        </div>

        <div class="summary-cards">
          <div class="summary-card invested">
            <div class="summary-label">累積投資金額</div>
            <div class="summary-value" id="totalInvested">1.2M</div>
          </div>
          <div class="summary-card total">
            <div class="summary-label">預估資產總額</div>
            <div class="summary-value highlight" id="totalValue">2.16M</div>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <h3 class="chart-title">投資曲線（<span id="currentPortfolioName">全天候策略</span>）</h3>
      <div class="chart-container">
        <canvas id="portfolioChart"></canvas>
      </div>
    </div>
  </div>

  <script>
    // ===== START: Real backtest data from CSV =====
    const csvData = `date,portfolio_monthly_return,portfolio_value,sp500_value
2015-09,0.0,10000,10000
2015-10,2.271599,10227,10852
2015-11,-1.414426,10083,10891
2015-12,-1.502895,9931,10704
2016-01,1.015771,10032,10171
2016-02,2.111957,10244,10162
2016-03,2.381067,10488,10846
2016-04,1.046763,10597,10887
2016-05,0.443005,10644,11073
2016-06,4.052757,11076,11112
2016-07,1.464033,11238,11517
2016-08,-0.576424,11173,11531
2016-09,-0.147926,11157,11532
2016-10,-3.005617,10821,11331
2016-11,-3.012744,10495,11749
2016-12,0.627506,10561,11986
2017-01,1.19988,10688,12201
2017-02,2.114288,10914,12682
2017-03,-0.575309,10851,12696
2017-04,1.040918,10964,12822
2017-05,1.086254,11083,13005
2017-06,0.244509,11110,13087
2017-07,0.837561,11203,13356
2017-08,1.86375,11412,13395
2017-09,-0.426925,11363,13665
2017-10,0.84423,11459,13987
2017-11,1.281231,11606,14414
2017-12,1.542012,11785,14589
2018-01,0.471687,11841,15410
2018-02,-2.918872,11495,14851
2018-03,0.950287,11604,14444
2018-04,-0.622368,11532,14518
2018-05,1.802512,11740,14871
2018-06,0.327534,11778,14958
2018-07,-0.122761,11764,15513
2018-08,1.637296,11956,16007
2018-09,-1.038716,11832,16102
2018-10,-3.743872,11389,14990
2018-11,0.717245,11471,15267
2018-12,-0.160578,11453,13922
2019-01,3.646326,11870,15036
2019-02,0.662051,11949,15526
2019-03,3.037201,12312,15805
2019-04,0.459212,12368,16452
2019-05,0.760011,12462,15401
2019-06,3.607017,12912,16474
2019-07,0.498755,12976,16722
2019-08,4.61607,13575,16443
2019-09,-0.85698,13459,16763
2019-10,0.466375,13522,17133
2019-11,0.664411,13611,17753
2019-12,0.173018,13635,18269
2020-01,3.123151,14061,18261
2020-02,0.05794,14069,16817
2020-03,-3.348366,13598,14717
2020-04,4.352715,14190,16586
2020-05,2.325617,14520,17376
2020-06,1.454857,14731,17684
2020-07,4.71578,15426,18725
2020-08,0.287759,15470,20032
2020-09,-1.360513,15260,19282
2020-10,-2.444568,14886,18802
2020-11,4.761613,15595,20846
2020-12,1.826644,15880,21619
2021-01,-1.605009,15625,21399
2021-02,-1.412703,15405,21994
2021-03,-1.60122,15158,22993
2021-04,3.53574,15694,24209
2021-05,0.948354,15843,24368
2021-06,2.425063,16227,24915
2021-07,2.592349,16648,25523
2021-08,0.467012,16725,26283
2021-09,-2.543278,16300,25057
2021-10,3.474466,16866,26816
2021-11,-0.019095,16863,26600
2021-12,1.028191,17036,27831
2022-01,-2.945627,16535,26363
2022-02,-0.33398,16479,25585
2022-03,-1.06482,16304,26547
2022-04,-6.974184,15167,24217
2022-05,-0.698237,15061,24272
2022-06,-3.82516,14485,22270
2022-07,3.94803,15057,24321
2022-08,-3.962692,14460,23329
2022-09,-7.57795,13364,21172
2022-10,0.129997,13382,22893
2022-11,5.502732,14118,24166
2022-12,-3.127028,13677,22773
2023-01,6.0976,14510,24205
2023-02,-3.903884,13944,23597
2023-03,3.674739,14456,24472
2023-04,0.536534,14534,24863
2023-05,-1.896712,14258,24977
2023-06,1.923189,14533,26596
2023-07,0.931534,14668,27467
2023-08,-2.044453,14368,27020
2023-09,-5.310268,13605,25739
2023-10,-3.046817,13191,25180
2023-11,7.294343,14153,27480
2023-12,5.137618,14880,28734
2024-01,-0.329659,14831,29192
2024-02,0.439259,14896,30715
2024-03,2.236529,15229,31720
2024-04,-4.101526,14604,30441
2024-05,2.198621,14925,31981
2024-06,2.357825,15277,33109
2024-07,2.592874,15674,33510
2024-08,1.633057,15929,34293
2024-09,1.844435,16223,35013
2024-10,-2.528466,15813,34701
2024-11,2.620457,16227,36770
2024-12,-3.871746,15599,35885
2025-01,1.966614,15906,36849
2025-02,2.109935,16242,36381
2025-03,-1.425067,16010,34354
2025-04,-0.91326,15864,34056
2025-05,0.504951,15944,36196
2025-06,3.048363,16430,37944
2025-07,0.160515,16456,38818
2025-08,0.315056,16508,39188
`;
    let backtestData = [];

    function parseCSV(csvString) {
      const lines = csvString.trim().split('\n');
      const headers = lines.shift().split(',');
      return lines.map(line => {
        const values = line.split(',');
        const entry = {};
        headers.forEach((header, index) => {
          const key = header.trim();
          const value = values[index].trim();
          entry[key] = isNaN(Number(value)) ? value : Number(value);
        });
        return entry;
      });
    }

    function getRealBacktestData(years) {
      const months = years * 12;
      // Slice from the end of the array to get the most recent data
      const slicedData = backtestData.slice(-months);

      const labels = slicedData.map(d => d.date);
      const pSeries = slicedData.map(d => d.portfolio_value);
      const sSeries = slicedData.map(d => d.sp500_value);
      
      return { labels, pSeries, sSeries };
    }
    // ===== END: Real backtest data from CSV =====

    // ===== Base data =====
    const portfolios = {
      "全天候策略": { allocations: { VTI: 30, TLT: 40, IEF: 15, GLD: 7.5, GSG: 7.5 }, CAGR: 0.078, volatility: 0.092, maxDrawdown: -0.28 },
      "三基金組合": { allocations: { VTI: 42, VXUS: 18, BND: 40 }, CAGR: 0.081, volatility: 0.105, maxDrawdown: -0.33 },
      "積極型股債組合": { allocations: { VT: 80, BNDW: 20 }, CAGR: 0.095, volatility: 0.132, maxDrawdown: -0.40 }
    };

    // Current portfolio for this page
    const selectedPortfolio = "全天候策略";
    let currentAllocations = { ...portfolios[selectedPortfolio].allocations };

    // State
    let years = 10;
    let backtestYears = 3;
    let divMode = 'drip';
    let initial = 100000;
    let monthly = 10000;
    let target = 1000000;

    let portfolioChart=null, backtestChart=null, pieChart = null;

    // Chart colors
    const pieColors = [
      '#208065', '#40A080', '#60C0A0', '#80E0C0', '#A0FFA0',
      '#806420', '#A08040', '#C0A060', '#E0C080', '#FFFF80'
    ];

    // ===== Chart.js global options =====
    Chart.defaults.elements.point.radius = 2;
    Chart.defaults.elements.point.hoverRadius = 3;
    Chart.defaults.animation = { duration: 200, easing: 'linear' };
    Chart.defaults.animations = { colors: { type: 'color', duration: 200, easing: 'linear' } };
    if(Chart.defaults.elements && Chart.defaults.elements.line){ Chart.defaults.elements.line.tension = 0; }

    // ===== Helpers =====
    function formatK(num){
      if(Math.abs(num) >= 1_000_000) return (num/1_000_000).toFixed(2).replace(/\.00$/,'') + 'M';
      if(Math.abs(num) >= 1_000) return (num/1_000).toFixed(1).replace(/\.0$/,'') + 'K';
      return num.toLocaleString();
    }
    function pct(n){ return (n*100).toFixed(1) + '%'; }
    function monthlyRate(annual){ return Math.pow(1+annual, 1/12) - 1; }

    // ===== Pie Chart Functions =====
    function initializePieChart() {
      const ctx = document.getElementById('pieChart').getContext('2d');
      if (pieChart) pieChart.destroy();
      pieChart = new Chart(ctx, {
        type: 'doughnut',
        data: { labels: [], datasets: [{ data: [], backgroundColor: pieColors, borderWidth: 2, borderColor: '#ffffff' }] },
        options: { responsive: true, maintainAspectRatio: true, plugins: { legend: { display: false } } }
      });
    }

    function updatePieChart(allocations) {
      if (!pieChart) return;
      const labels = [];
      const data = [];
      const legendContainer = document.getElementById('allocationLegend');
      legendContainer.innerHTML = '';
      let colorIndex = 0;
      for (const [asset, percentage] of Object.entries(allocations)) {
        if (percentage > 0) {
          labels.push(asset);
          data.push(percentage);
          const legendItem = document.createElement('div');
          legendItem.className = 'legend-item';
          legendItem.innerHTML = `<div class="legend-color" style="background-color: ${pieColors[colorIndex]}"></div><div class="legend-text">${asset}: ${percentage}%</div>`;
          legendContainer.appendChild(legendItem);
          colorIndex++;
        }
      }
      pieChart.data.labels = labels;
      pieChart.data.datasets[0].data = data;
      pieChart.update();
    }

    // ===== Calculations =====
    function buildProjectionSeries(years, initial, monthly, annualReturn){
      const data=[]; 
      let invested=initial, value=initial; 
      const m = monthly; 
      const r = monthlyRate(annualReturn);
      let targetYear=null;
      for(let y=1;y<=years;y++){
        for(let i=0;i<12;i++){ value = (value + m) * (1+r); invested += m; }
        if(!targetYear && value >= target) targetYear = y;
        data.push({ year:`${y}年`, invested:Math.round(invested), value:Math.round(value) });
      }
      return { data, invested, value, targetYear };
    }

    // ===== Charts =====
    function updatePortfolioChart(data){
      const ctx = document.getElementById('portfolioChart').getContext('2d');
      if(portfolioChart) portfolioChart.destroy();
      portfolioChart = new Chart(ctx, {
        type:'line',
        data:{
          labels: data.map(d=>d.year),
          datasets:[
            { label:'累積投入金額', data:data.map(d=>d.invested), borderColor:'#2aa27f', backgroundColor:'rgba(21,90,71,.20)', fill:true, tension:.1 },
            { label:'累積總資產', data:data.map(d=>d.value), borderColor:'#5bc7a7', backgroundColor:'rgba(32,128,100,.25)', fill:true, tension:.1 }
          ]
        },
        options:{
          responsive:true, maintainAspectRatio:false,
          plugins:{ legend:{ labels:{ color:'#fff' } } },
          interaction:{ mode:'index', intersect:false },
          scales:{
            x:{ ticks:{ color:'#fff' }, grid:{ color:'rgba(255,255,255,.1)' } },
            y:{ ticks:{ color:'#fff', callback:v=>formatK(v) }, grid:{ color:'rgba(255,255,255,.1)' } }
          }
        }
      });
    }

    function updateBacktestChart(){
      const ctx = document.getElementById('backtestChart').getContext('2d');
      if(backtestChart) backtestChart.destroy();

      // Get real data based on selected years
      const data = getRealBacktestData(backtestYears);
      const xLabels = data.labels;
      
      const tickFontSize = window.innerWidth < 768 ? 10 : 12;

      backtestChart = new Chart(ctx, {
        type:'line',
        data:{
          labels:xLabels,
          datasets:[
            { label: selectedPortfolio, data:data.pSeries, borderColor:'#5bc7a7', backgroundColor:'rgba(32,128,100,0)', fill:false, tension:0 },
            { label:'S&P 500', data:data.sSeries, borderColor:'#FFD700', backgroundColor:'rgba(255,215,0,0)', fill:false, tension:0 }
          ]
        },
        options:{
          responsive:true, maintainAspectRatio:false,
          plugins:{ legend:{ labels:{ color:'#fff' } } },
          interaction:{ mode:'index', intersect:false },
          scales:{
            x:{
              ticks:{
                color:'#fff',
                autoSkip:true,
                maxTicksLimit: Math.min(12, backtestYears*4),
                font: { size: tickFontSize },
                callback: function(value){
                  const raw = xLabels[value];
                  if(typeof raw === 'string' && raw.includes('-')){
                    const [y,m] = raw.split('-');
                    if (parseInt(m) % 3 === 1) { return `${y}/${m}`; }
                    return null;
                  }
                  return raw;
                }
              },
              grid:{ color:'rgba(255,255,255,.08)' }
            },
            y:{ ticks:{ color:'#fff', callback:v=>formatK(v) }, grid:{ color:'rgba(255,255,255,.08)' } }
          }
        }
      });
    }

    // ===== Update flows =====
    function updatePerformanceFromWeights(){
      const portfolio = portfolios[selectedPortfolio];
      document.getElementById('annualReturn').textContent = pct(portfolio.CAGR);
      document.getElementById('volatility').textContent = pct(portfolio.volatility);
      document.getElementById('maxDrawdown').textContent = (portfolio.maxDrawdown*100).toFixed(1) + '%';
    }

    function updateProjectionAndSummary(){
      const portfolio = portfolios[selectedPortfolio];
      const { data, invested, value } = buildProjectionSeries(years, initial, monthly, portfolio.CAGR + 0.02);
      document.getElementById('totalInvested').textContent = formatK(invested);
      document.getElementById('totalValue').textContent = formatK(value);
      const totalInvestedAmount = initial + monthly * 12 * years;
      const totalReturnPct = totalInvestedAmount>0 ? ((value-totalInvestedAmount)/totalInvestedAmount)*100 : 0;
      document.getElementById('totalReturnPct').textContent = totalReturnPct.toFixed(1) + '%';
      document.getElementById('currentPortfolioName').textContent = selectedPortfolio;
      updatePortfolioChart(data);
    }

    function updateAllCharts(){
      updateProjectionAndSummary();
      updateBacktestChart();
    }

    // ===== Event wiring =====
    document.addEventListener('DOMContentLoaded', ()=>{
      backtestData = parseCSV(csvData);
      setTimeout(() => {
        initializePieChart();
        updatePieChart(currentAllocations);
        updatePerformanceFromWeights();
        updateAllCharts();
      }, 100);

      document.querySelectorAll('.horizon-years').forEach(btn=>{
        btn.addEventListener('click', function(){
          document.querySelectorAll('.horizon-years').forEach(b=>b.classList.remove('active'));
          this.classList.add('active');
          years = parseInt(this.getAttribute('data-years'));
          updateProjectionAndSummary();
        });
      });

      document.querySelectorAll('.backtest-years').forEach(btn=>{
        btn.addEventListener('click', function(){
          document.querySelectorAll('.backtest-years').forEach(b=>b.classList.remove('active'));
          this.classList.add('active');
          backtestYears = parseInt(this.getAttribute('data-years'));
          updateBacktestChart();
        });
      });

      document.querySelectorAll('input[name="divMode"]').forEach(r=>{
        r.addEventListener('change', function(){
          divMode = this.value;
        });
      });

      document.getElementById('initial').addEventListener('input', function(){ initial = Number(this.value)||0; updateProjectionAndSummary(); });
      document.getElementById('monthly').addEventListener('input', function(){ monthly = Number(this.value)||0; updateProjectionAndSummary(); });
      document.getElementById('target').addEventListener('input', function(){ target = Number(this.value)||0; updateProjectionAndSummary(); });
    });
  </script>
</body>
</html>